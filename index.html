<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å¥³é¢¨æ¨¡æ“¬æ‰‹æ©Ÿ - åŠŸèƒ½å®Œå…¨é«”</title>
    <style>
        :root {
            --primary-pink: #ffafcc;
            --light-pink: #ffc2d1;
            --accent-pink: #fb6f92;
            --bg-color: #fff0f3;
            --text-color: #5c5c5c;
            --price-red: #ff4d4f;
        }

        body { background: #ffe5ec; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }

        /* iPhone æ¡†æ¶ */
        .iphone-frame { width: 375px; height: 760px; background: #333; border-radius: 55px; padding: 12px; box-shadow: 0 50px 100px rgba(0,0,0,0.3); position: relative; }
        .phone { width: 100%; height: 100%; background: white; border-radius: 43px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .notch { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 30px; background: black; border-radius: 20px; z-index: 5000; }

        /* é ‚éƒ¨æ¨™é¡Œèˆ‡å¥½æ„Ÿåº¦ */
        .header { background: var(--primary-pink); color: white; padding: 45px 25px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .tab-bar { display: flex; background: white; border-bottom: 1px solid #eee; z-index: 10; }
        .tab-item { flex: 1; text-align: center; padding: 12px; font-size: 14px; cursor: pointer; color: #888; }
        .tab-item.active { color: var(--accent-pink); font-weight: bold; border-bottom: 2px solid var(--accent-pink); }

        .content-view { flex: 1; overflow-y: auto; display: none; background: var(--bg-color); }
        .content-view.active { display: block; }

        /* èŠå¤©æ°£æ³¡ */
        .chat-area { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg-row { display: flex; gap: 8px; align-items: flex-start; transition: 0.3s; position: relative; }
        .msg-row.user-row { flex-direction: row-reverse; }
        .select-box { width: 0; overflow: hidden; display: flex; align-items: center; transition: 0.3s; }
        .delete-mode .select-box { width: 30px; }
        .bubble { max-width: 68%; padding: 12px 14px; border-radius: 20px; font-size: 14px; word-wrap: break-word; cursor: pointer; user-select: none; position: relative; }
        .bubble.ai { background: white; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--primary-pink); color: white; border-bottom-right-radius: 4px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background-size: cover; background-color: var(--light-pink); cursor: pointer; flex-shrink: 0; }
        .avatar-ai { background-image: url('https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee'); }
        .avatar-user { background-image: url('https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky'); }

        /* è¡¨æƒ…é¢æ¿ */
        #emoji-panel {
            position: absolute; bottom: -380px; left: 0; width: 100%; height: 350px;
            background: white; border-top-left-radius: 25px; border-top-right-radius: 25px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 8000;
            transition: bottom 0.3s ease; display: flex; flex-direction: column;
        }
        .e-tabs { display: flex; background: #f9f9f9; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .e-tab { flex: 1; padding: 12px; text-align: center; font-size: 12px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
        .e-tab.active { color: var(--accent-pink); border-bottom-color: var(--accent-pink); font-weight: bold; }
        .e-content { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; align-content: start; }
        .emoji-item { font-size: 26px; text-align: center; cursor: pointer; }
        .kao-item { grid-column: span 3; font-size: 13px; background: #fff0f3; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; }
        .st-item { grid-column: span 2; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .st-img { width: 100%; height: 60px; object-fit: cover; border-radius: 8px; background: #eee; }
        .emoji-section-title { grid-column: 1 / 8; font-size: 11px; color: #aaa; margin: 10px 0 5px; }

        /* å•†åŸè¦–åœ– */
        .mall-user-info { display: flex; align-items: center; padding: 12px 15px; background: white; gap: 10px; border-bottom: 1px solid #eee; }
        .mall-sub-nav { display: flex; gap: 8px; padding: 10px; background: white; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #eee; }
        .category-btn { padding: 5px 12px; background: #fff0f3; border-radius: 15px; font-size: 11px; cursor: pointer; }
        .category-btn.active { background: var(--primary-pink); color: white; }
        .mall-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .product-card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .product-img { width: 100%; height: 100px; background: #fffafa; display: flex; justify-content: center; align-items: center; font-size: 40px; }
        .product-info { padding: 10px; }
        .buy-btn { width: 100%; background: linear-gradient(45deg, #ff9000, #ff5000); color: white; border: none; border-radius: 20px; padding: 6px; cursor: pointer; font-size: 11px; }

        /* è¨­å®šé¢æ¿ */
        #settings-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9000; display: none; flex-direction: column; }
        .settings-header { display: flex; align-items: center; padding: 45px 15px 15px; border-bottom: 1px solid #eee; }
        .settings-tabs { display: flex; background: #f9f9f9; }
        .s-tab { flex: 1; padding: 10px; text-align: center; font-size: 11px; cursor: pointer; border-bottom: 1px solid #ddd; }
        .s-tab.active { border-bottom: 2px solid var(--accent-pink); color: var(--accent-pink); font-weight: bold; }
        .s-content { padding: 15px; flex: 1; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ffdae0; border-radius: 12px; box-sizing: border-box; outline: none; }
        textarea { width: 100%; height: 100px; border: 1px solid #ffdae0; border-radius: 12px; padding: 10px; font-size: 12px; resize: none; box-sizing: border-box; }

        /* åº•éƒ¨ */
        .footer-container { background: #fff; border-top: 1px solid #eee; padding-bottom: 25px; transition: 0.3s; }
        .footer { padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        input#msg-input { flex: 1; border: none; background: #f0f0f0; border-radius: 20px; padding: 10px 15px; outline: none; }
        #action-sheet { position: absolute; bottom: -280px; left: 0; width: 100%; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; z-index: 9500; display: flex; flex-direction: column; transition: 0.3s; padding-bottom: 30px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .action-item { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 15px; }
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 120px; height: 5px; background: #ccc; border-radius: 10px; }
    </style>
</head>
<body>

<div class="iphone-frame">
    <div class="notch"></div>
    <div class="phone">
        <div class="header">
            <div style="width: 20px;"></div> 

            <div style="display: flex; flex-direction: column; align-items: center;">
                <span id="display-char-name" style="font-size: 15px;">ğŸ€ AI å°ç”œå¿ƒ</span>
                <div style="font-size: 10px; margin-top: 2px; opacity: 0.9; font-weight: normal;">
                    ğŸ’– <span id="header-favor">520</span>
                </div>
            </div>

            <div onclick="toggleSettings(true)" style="cursor:pointer; font-size: 18px;">âš™ï¸</div>
        </div>

        <div class="tab-bar">
            <div class="tab-item active" onclick="switchView('chat', this)">æ¶ˆæ¯</div>
            <div class="tab-item" onclick="switchView('mall', this)">å•†åŸ</div>
        </div>
        
        <div id="view-chat" class="content-view active" onclick="closePopups()">
            <div class="chat-area" id="chat"></div>
        </div>

        <div id="view-mall" class="content-view">
            <div class="mall-user-info">
                <div class="avatar avatar-user" style="width:35px; height:35px;"></div>
                
                <div style="flex:1; font-size:12px; margin-left: 10px;">
                    <div style="display: flex; align-items: center;">
                        <b id="display-user-name">å¹¸é‹å°ä¸»</b>
                        <span onclick="filterMall('bag', null)" style="cursor:pointer; margin-left: 5px; font-size: 14px;" title="æˆ‘çš„èƒŒåŒ…">ğŸ’</span>
                    </div>
                    <div style="margin-top: 2px;">é¤˜é¡: <span id="mall-balance" style="color:var(--price-red);">1000</span></div>
                </div>

                <div style="display: flex; gap: 5px;">
                    <button onclick="aiAddNewProducts(null)" style="background: white; color: var(--accent-pink); border: 1px solid var(--accent-pink); border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">âœ¨ ä¸Šæ–°</button>
                    <button onclick="aiAutoShop()" style="background:var(--accent-pink); color:white; border:none; border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">è®“ Ta é¸è³¼</button>
                </div>
            </div>

            <div class="mall-sub-nav">
                <div class="category-btn active" onclick="filterMall('all', this)">ğŸ“¦ å…¨éƒ¨</div>
                <div class="category-btn" onclick="filterMall('food', this)">ğŸ¦ é£Ÿç‰©</div>
                <div class="category-btn" onclick="filterMall('cloth', this)">ğŸ‘— è¡£æœ</div>
            </div>

            <div class="mall-grid" id="mall-display"></div>
        </div>

        <div id="emoji-panel" onclick="event.stopPropagation()">
            <div class="e-tabs">
                <div class="e-tab active" onclick="switchETab(0)">Emoji</div>
                <div class="e-tab" onclick="switchETab(1)">é¡æ–‡å­—</div>
                <div class="e-tab" onclick="switchETab(2)">AIè¡¨æƒ…åº«</div>
            </div>
            <div id="emoji-content" class="e-content"></div>
        </div>

        <div id="settings-panel">
            <div class="settings-header">
                <div onclick="toggleSettings(false)" style="color:var(--accent-pink); cursor:pointer; font-weight:bold;">ï¼œ è¿”å›</div>
                <div style="flex:1; text-align:center; font-weight:bold; margin-right:30px;">è¨­å®šä¸­å¿ƒ</div>
            </div>
            <div class="settings-tabs">
                <div class="s-tab active" onclick="switchSTab(0)">API</div>
                <div class="s-tab" onclick="switchSTab(1)">Useräººè¨­</div>
                <div class="s-tab" onclick="switchSTab(2)">Charäººè¨­</div>
                <div class="s-tab" onclick="switchSTab(3)">ä¸–ç•Œæ›¸</div>
            </div>
            <div class="s-content" id="s-content-box"></div>
            <div style="padding:15px; border-top:1px solid #eee;">
                <button onclick="saveAllSettings()" style="width:100%; background:var(--accent-pink); color:white; border:none; border-radius:15px; padding:12px; font-weight:bold;">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div class="footer-container" id="footer-group">
            <div class="footer">
                <div class="icon-btn" onclick="toggleEmoji(event)">ğŸ˜Š</div>
                <input type="text" id="msg-input" placeholder="å‚³é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') userSubmit()">
                <div class="icon-btn" onclick="toggleTools()">â•</div>
                <button style="background:transparent; border:none; font-size:28px; cursor:pointer;" onclick="jupiterTrigger()">ğŸª</button>
            </div>
            <div class="home-indicator"></div>
        </div>

        <div id="action-sheet">
            <div class="action-item" onclick="editCurrentMsg()">ç·¨è¼¯</div>
            <div class="action-item" id="regen-btn" onclick="regenCurrentMsg()">é‡æ–°ç”Ÿæˆ</div>
            <div class="action-item" onclick="enterDeleteMode()">å¤šé¸åˆªé™¤</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
        </div>
    </div>
</div>

<script>
    // --- æ•¸æ“šç‹€æ…‹ ---
    // æ–°å¢: inventory (ä¿®æ­£èƒŒåŒ…å ±éŒ¯), currentTargetId (ç”¨æ–¼æ“ä½œèœå–®), timer (ç”¨æ–¼é•·æŒ‰)
    let balance = 1000, favor = 520, lastUserMsg = "", stickerLib = JSON.parse(localStorage.getItem('stickerLib') || '[]');
    let inventory = []; 
    let currentTargetId = null;
    let timer = null;
    
    // é è¨­æ•¸æ“š
    let userData = { name: "å¹¸é‹å°ä¸»", info: "å–œæ­¡å¯æ„›æ±è¥¿çš„æ—…è¡Œè€…ã€‚" };
    let charData = { name: "AI å°ç”œå¿ƒ", info: "æ´»æ½‘é–‹æœ—ï¼Œä¾è³´ä¸»äººçš„å°‘å¥³ã€‚" };
    let products = [{id:1, name:"è‰è“å¤§å¹…", price:25, icon:"ğŸ¡", cat:"food"}, {id:2, name:"èŒèŒå¥³åƒ•è£", price:450, icon:"ğŸ‘—", cat:"cloth"}];
    
    // è¡¨æƒ…åº«
    const emojiFaces = ["ğŸ˜Š","ğŸ˜ƒ","ğŸ¤£","ğŸ˜‡","ğŸ˜‹","ğŸ§","ğŸ¥³","ğŸ˜","ğŸ˜”","ğŸ¥º","ğŸ¥µ","ğŸ¤¯"];
    const emojiFood = ["ğŸ“","ğŸ°","ğŸ¨","ğŸ§‹","â˜•","ğŸ¬"];
    const kaomojis = ["(âœ¿â—¡â€¿â—¡)", "(Â´â–½`Êƒâ™¡Æª)", "(ï½¡â™¥â€¿â™¥ï½¡)", "o(*^â–½^*)o", "(>_<)", "(OwO)"];

    // åˆå§‹åŒ–
    window.onload = () => { 
        loadAll(); 
        updateUI(); 
        switchETab(0); 
        switchSTab(0); 
        filterMall('all', document.querySelector('.category-btn')); 
        appendMessage('ai', "ä¸»äººï¼å•†åŸã€è¨­å®šã€é‚„æœ‰ä½ çš„æµ·é‡è¡¨æƒ…åŒ…å…¨éƒ½å›ä¾†å•¦ï¼ğŸŒ¸âœ¨"); 
    };

    // --- è¦–åœ–èˆ‡ä»‹é¢æ§åˆ¶ ---
    function switchView(view, el) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active'); 
        el.classList.add('active');
        document.getElementById('footer-group').style.display = (view === 'chat') ? 'block' : 'none';
    }

    function toggleSettings(s) { document.getElementById('settings-panel').style.display = s ? 'flex' : 'none'; }

    // --- è¨­å®šåˆ†é é‚è¼¯ ---
    function switchSTab(idx) {
        const box = document.getElementById('s-content-box');
        document.querySelectorAll('.s-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        
        if(idx === 0) {
            // ä¿®æ”¹é»ï¼šå¢åŠ äº†æŒ‰éˆ•ï¼Œä¸¦å„ªåŒ–äº†æ’ç‰ˆ
            box.innerHTML = `
                <div class="input-group"><label>API Base URL</label><input id="api-url" value="${localStorage.getItem('apiUrl') || 'https://api.openai.com/v1'}"></div>
                <div class="input-group"><label>API Key</label><input type="password" id="api-key" value="${localStorage.getItem('apiKey') || ''}"></div>
                <div class="input-group">
                    <label>æ¨¡å‹é¸æ“‡</label>
                    <div style="display:flex; gap:5px;">
                        <select id="api-model" style="flex:1;">
                            <option value="${localStorage.getItem('apiModel') || 'gpt-3.5-turbo'}">${localStorage.getItem('apiModel') || 'gpt-3.5-turbo (ç•¶å‰)'}</option>
                        </select>
                        <button id="btn-fetch-models" onclick="fetchModels()" style="padding:0 10px; border:1px solid #ffafcc; background:white; border-radius:10px; cursor:pointer;">ğŸ”„ å–å¾—æ¨¡å‹</button>
                    </div>
                </div>`;
        } else if(idx === 1) {
            // ä¿®æ”¹é»ï¼šå¢åŠ äº† User é ­åƒæ¬„ä½
            box.innerHTML = `
                <div class="input-group"><label>User åå­—</label><input id="u-name" value="${userData.name}"></div>
                <div class="input-group"><label>User é ­åƒ (URL)</label><input id="u-avatar" value="${userData.avatar || ''}" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ..."></div>
                <div class="input-group"><label>è¨­å®š / å‚™å¿˜éŒ„</label><textarea id="u-info">${userData.info}</textarea></div>`;
        } else if(idx === 2) {
            // ä¿®æ”¹é»ï¼šå¢åŠ äº† Char é ­åƒæ¬„ä½
            box.innerHTML = `
                <div class="input-group"><label>AI åå­—</label><input id="c-name" value="${charData.name}"></div>
                <div class="input-group"><label>AI é ­åƒ (URL)</label><input id="c-avatar" value="${charData.avatar || ''}" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ..."></div>
                <div class="input-group"><label>AI äººè¨­</label><textarea id="c-info">${charData.info}</textarea></div>`;
        } else if(idx === 3) {
            box.innerHTML = `<input type="file" id="wb-upload" onchange="importWB(event)"><p style="font-size:10px; color:#888; margin-top:10px;">æ”¯æ´å°å…¥ JSON æ ¼å¼çš„ä¸–ç•Œæ›¸æˆ–è¨­å®šæª”ã€‚</p>`;
        }
    }
    // è£œå…¨: ä¸–ç•Œæ›¸å°å…¥é‚è¼¯
    function importWB(event) {
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                localStorage.setItem('world_book', JSON.stringify(json));
                alert("ğŸ“– ä¸–ç•Œæ›¸å°å…¥æˆåŠŸï¼å·²å­˜å…¥è¨˜æ†¶åº«ã€‚");
            } catch(err) {
                alert("âŒ æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä¸Šå‚³æ­£ç¢ºçš„ JSON æ–‡æª”ã€‚");
            }
        };
        reader.readAsText(file);
    }

    // --- è¡¨æƒ…èˆ‡è²¼åœ–é‚è¼¯ ---
    function switchETab(idx) {
        const content = document.getElementById('emoji-content');
        document.querySelectorAll('.e-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        content.innerHTML = ''; content.className = 'e-content';
        if(idx === 0) {
            addESec(content, "è¡¨æƒ…èˆ‡äººç‰©", emojiFaces); addESec(content, "é£Ÿç‰©é¡", emojiFood);
        } else if(idx === 1) {
            content.classList.add('kaomoji');
            kaomojis.forEach(k => {
                const d = document.createElement('div'); d.className = 'kao-item'; d.innerText = k; d.onclick = () => { document.getElementById('msg-input').value += k; }; content.appendChild(d);
            });
        } else if(idx === 2) {
            content.classList.add('stickers');
            content.innerHTML = `<button onclick="uploadSticker()" style="grid-column:span 4; margin-bottom:10px; border:1px dashed #ccc; background:white; border-radius:10px; color:#888;">+ ä¸Šå‚³æ–°è²¼åœ–</button>`;
            stickerLib.forEach(s => {
                const d = document.createElement('div'); d.className = 'st-item';
                d.innerHTML = `<img src="${s.url}" class="st-img"><span style="font-size:9px;">${s.name}</span>`;
                d.onclick = () => sendStickerLabel(s.name); content.appendChild(d);
            });
        }
    }
    function addESec(c, t, l) {
        const h = document.createElement('div'); h.className = 'emoji-section-title'; h.innerText = t; c.appendChild(h);
        l.forEach(e => { const s = document.createElement('span'); s.className = 'emoji-item'; s.innerText = e; s.onclick = () => { document.getElementById('msg-input').value += e; }; c.appendChild(s); });
    }

    // --- è¨Šæ¯ç®¡ç† ---
    function appendMessage(role, content) {
        const chat = document.getElementById('chat'); const id = 'msg-' + Date.now(); const row = document.createElement('div');
        row.className = `msg-row ${role === 'user' ? 'user-row' : ''}`; row.id = id;
        // æ³¨æ„ï¼šé•·æŒ‰äº‹ä»¶åœ¨é€™è£¡ç¶å®š
        row.innerHTML = `<div class="select-box"><input type="checkbox"></div><div class="avatar avatar-${role}" ondblclick="nudge()"></div><div class="bubble ${role}">${parseSticker(content)}</div>`;
        row.onmousedown = () => { timer = setTimeout(() => showAction(id, role), 600); }; 
        row.onmouseup = () => clearTimeout(timer);
        row.ontouchstart = () => { timer = setTimeout(() => showAction(id, role), 600); }; // å¢åŠ æ‰‹æ©Ÿç«¯æ”¯æ´
        row.ontouchend = () => clearTimeout(timer);
        chat.appendChild(row); document.getElementById('view-chat').scrollTop = document.getElementById('view-chat').scrollHeight;
    }
    
    function parseSticker(t) { return t.replace(/\[è¡¨æƒ…:\s*(.+?)\]/g, (m, n) => { const s = stickerLib.find(x => x.name === n); return s ? `<img src="${s.url}" style="max-width:130px; border-radius:10px; display:block; margin:5px 0;">` : m; }); }
    function nudge() { appendMessage('ai', `å“å‘€ï¼ä¸è¦æ‹æ‹æˆ‘å•¦ï½ğŸŒ¸`); }

    // è£œå…¨: æ¶ˆæ¯æ“ä½œåŠŸèƒ½ (ç·¨è¼¯ã€é‡ç½®ã€åˆªé™¤)
    function showAction(id, role) { currentTargetId = id; document.getElementById('action-sheet').style.bottom = '0'; }
    function hideActionSheet() { document.getElementById('action-sheet').style.bottom = '-280px'; }
    
    function editCurrentMsg() {
        if(!currentTargetId) return;
        const bubble = document.getElementById(currentTargetId).querySelector('.bubble');
        const newTxt = prompt("ç·¨è¼¯æ¶ˆæ¯ï¼š", bubble.innerText);
        if(newTxt) bubble.innerText = newTxt;
        hideActionSheet();
    }
    
    function regenCurrentMsg() {
        // ç°¡å–®é‚è¼¯ï¼šåˆªé™¤æœ€å¾Œä¸€æ¢ AI æ¶ˆæ¯ä¸¦è§¸ç™¼é‡æ–°ç”Ÿæˆ
        const chat = document.getElementById('chat');
        if(chat.lastChild && chat.lastChild.querySelector('.avatar-ai')) {
            chat.removeChild(chat.lastChild);
            jupiterTrigger(); // é‡æ–°è§¸ç™¼ API
        }
        hideActionSheet();
    }
    
    function enterDeleteMode() {
        document.body.classList.add('delete-mode');
        alert("å·²é€²å…¥åˆªé™¤æ¨¡å¼ï¼Œé¸ä¸­æ°£æ³¡å¾Œè«‹é»æ“Šé ‚éƒ¨è¿”å›é€€å‡º (åˆªé™¤é‚è¼¯éœ€å¾Œç«¯é…åˆï¼Œæ­¤ç‚ºæ¼”ç¤º UI)");
        hideActionSheet();
        // æ¼”ç¤ºï¼š3ç§’å¾Œè‡ªå‹•é€€å‡ºï¼Œå¯¦éš›é–‹ç™¼å¯åŠ å€‹åˆªé™¤æŒ‰éˆ•
        setTimeout(() => document.body.classList.remove('delete-mode'), 3000);
    }

    // --- å•†åŸé‚è¼¯ ---
    function filterMall(cat, el) {
        if(el) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
        const display = document.getElementById('mall-display'); display.innerHTML = '';
        const f = cat === 'all' ? products : (cat === 'bag' ? inventory : products.filter(p => p.cat === cat));
        f.forEach((p, idx) => {
            display.innerHTML += `<div class="product-card"><div class="product-img">${p.icon}</div><div class="product-info"><div style="font-size:11px;">${p.name}</div><div style="color:red; font-weight:bold;">Â¥${p.price || '--'}</div><button class="buy-btn" onclick="${cat==='bag'?'useItem('+idx+')':'buyProd('+p.id+')'}">${cat==='bag'?'ä½¿ç”¨':'è³¼è²·'}</button></div></div>`;
        });
    }

    // è£œå…¨: å•†åŸè‡ªå‹•åŠŸèƒ½
    function aiAutoShop() {
        const item = products[Math.floor(Math.random() * products.length)];
        if(balance >= item.price) {
            balance -= item.price;
            inventory.push(item);
            updateUI();
            alert(`AI è‡ªå·±è²·äº† ${item.name}ï¼å¥½é–‹å¿ƒï¼âœ¨`);
        } else {
            alert("å—šå—šï¼Œé¤˜é¡ä¸è¶³ï¼Œè²·ä¸èµ·...");
        }
    }
    
    function aiAddNewProducts(el) {
        filterMall('all', el); // æš«æ™‚åˆ‡æ›å›å…¨éƒ¨
        alert("âœ¨ é­”æ³•åˆ·æ–°ï¼å•†åŸè²¨æ¶æ•´ç†ä¸­...");
    }

    // --- å­˜æª”èˆ‡åˆå§‹åŒ– ---
    function loadAll() {
        const u = localStorage.getItem('userData'), c = localStorage.getItem('charData'), inv = localStorage.getItem('inventory');
        if(u) userData = JSON.parse(u); 
        if(c) charData = JSON.parse(c);
        if(inv) inventory = JSON.parse(inv);
    }
    function updateUI() {
        document.getElementById('header-favor').innerText = favor; 
        document.getElementById('mall-balance').innerText = balance;
        document.getElementById('display-char-name').innerText = "ğŸ€ " + charData.name; 
        document.getElementById('display-user-name').innerText = userData.name;
        
        // --- æ–°å¢: å‹•æ…‹æ›´æ–°é ­åƒ ---
        // å¦‚æœæ²’æœ‰è¨­å®šé ­åƒï¼Œå°±ä½¿ç”¨é è¨­çš„ DiceBear åœ–ç‰‡
        const defaultUser = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky';
        const defaultChar = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee';
        
        const userUrl = userData.avatar || defaultUser;
        const charUrl = charData.avatar || defaultChar;

        // å¼·åˆ¶æ›´æ–°æ‰€æœ‰ç›¸é—œçš„é ­åƒå…ƒç´ 
        document.querySelectorAll('.avatar-user').forEach(el => el.style.backgroundImage = `url('${userUrl}')`);
        document.querySelectorAll('.avatar-ai').forEach(el => el.style.backgroundImage = `url('${charUrl}')`);

        // åŒæ­¥ä¿å­˜
        localStorage.setItem('userData', JSON.stringify(userData));
        localStorage.setItem('charData', JSON.stringify(charData));
        localStorage.setItem('inventory', JSON.stringify(inventory));
    }

    // --- å…¶ä»–åŠŸèƒ½èˆ‡ API ---
    function toggleEmoji(e) { e.stopPropagation(); const p = document.getElementById('emoji-panel'); p.style.bottom = p.style.bottom === '0px' ? '-380px' : '0px'; }
    function closePopups() { document.getElementById('emoji-panel').style.bottom = '-380px'; hideActionSheet(); }
    
    function userSubmit() { 
        const i = document.getElementById('msg-input'); 
        if(i.value.trim()){ 
            appendMessage('user', i.value); 
            lastUserMsg = i.value; 
            i.value = ''; 
            closePopups(); 
            // ç”¨æˆ¶ç™¼é€å¾Œè‡ªå‹•è§¸ç™¼ AI å›è¦†
            setTimeout(jupiterTrigger, 1000);
        } 
    }
    
    // è£œå…¨: API é€£æ¥é‚è¼¯ (Jupiter Trigger)
    async function jupiterTrigger() {
        const apiKey = document.getElementById('api-key')?.value || localStorage.getItem('apiKey');
        const apiUrl = document.getElementById('api-url')?.value || "https://api.openai.com/v1";
        
        // æ¨¡æ“¬æ€è€ƒç‹€æ…‹
        const tempId = 'thinking-' + Date.now();
        const chat = document.getElementById('chat');
        const loadingRow = document.createElement('div');
        loadingRow.className = 'msg-row'; loadingRow.id = tempId;
        loadingRow.innerHTML = `<div class="avatar avatar-ai"></div><div class="bubble ai" style="color:#aaa;">(æ€è€ƒä¸­...ğŸª)</div>`;
        chat.appendChild(loadingRow);
        chat.scrollTop = chat.scrollHeight;

        if (!apiKey) {
            document.getElementById(tempId).remove();
            appendMessage('ai', "ä¸»äººï¼Œè«‹å…ˆé»æ“Šå³ä¸Šè§’âš™ï¸è¨­å®šï¼Œè¼¸å…¥æ‚¨çš„ API Key å“¦ï¼");
            return;
        }

        try {
            // é€™è£¡æ§‹å»ºä¸€å€‹ç°¡å–®çš„è«‹æ±‚
            const messages = [
                { role: "system", content: `${charData.name}çš„è¨­å®š: ${charData.info}ã€‚ç”¨æˆ¶æ˜¯${userData.name}: ${userData.info}ã€‚è«‹ç”¨å¯æ„›ã€ç°¡çŸ­çš„èªæ°£å°è©±ã€‚` },
                { role: "user", content: lastUserMsg || "æ—©å®‰" }
            ];

            const res = await fetch(`${apiUrl}/chat/completions`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({ model: "gpt-3.5-turbo", messages: messages })
            });

            const data = await res.json();
            document.getElementById(tempId).remove(); // ç§»é™¤æ€è€ƒæ°£æ³¡

            if (data.choices && data.choices.length > 0) {
                appendMessage('ai', data.choices[0].message.content);
            } else {
                appendMessage('ai', "å—šå—šï¼Œé€£æ¥å¤–æ˜Ÿè¨Šè™Ÿå¤±æ•—äº†... (API Error)");
            }
        } catch (e) {
            document.getElementById(tempId).remove();
            appendMessage('ai', `ç™¼ç”ŸéŒ¯èª¤äº†ï¼š${e.message}`);
        }
    }

    function uploadSticker() { 
        const n = prompt("è¡¨æƒ…åç¨±ï¼š"); if(!n) return;
        const i = document.createElement('input'); i.type = 'file'; i.onchange = (e) => {
            const r = new FileReader(); r.onload = (ev) => { stickerLib.push({name: n, url: ev.target.result}); localStorage.setItem('stickerLib', JSON.stringify(stickerLib)); switchETab(2); }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }
    function sendStickerLabel(n) { appendMessage('user', `[è¡¨æƒ…: ${n}]`); closePopups(); setTimeout(jupiterTrigger, 1000); }
    function buyProd(id) { const p = products.find(x => x.id === id); if(balance >= p.price){ balance -= p.price; inventory.push(p); updateUI(); alert("å·²è³¼è²·"); } else { alert("é¤˜é¡ä¸è¶³ï¼"); } }
    function useItem(idx) { inventory.splice(idx, 1); updateUI(); filterMall('bag', null); alert("ä½¿ç”¨äº†ç‰©å“ï¼å¥½æ„Ÿåº¦ä¸Šå‡ï¼ğŸ’–"); favor+=10; updateUI(); }
    
    function saveAllSettings() { 
        // 1. ä¿å­˜ API è¨­å®š
        if(document.getElementById('api-url')) {
            localStorage.setItem('apiUrl', document.getElementById('api-url').value);
            localStorage.setItem('apiKey', document.getElementById('api-key').value);
            localStorage.setItem('apiModel', document.getElementById('api-model').value);
        }
        
        // 2. ä¿å­˜ User æ•¸æ“š (å«é ­åƒ)
        if(document.getElementById('u-name')) {
            userData.name = document.getElementById('u-name').value;
            userData.info = document.getElementById('u-info').value;
            userData.avatar = document.getElementById('u-avatar').value; // æ–°å¢
        }

        // 3. ä¿å­˜ Char æ•¸æ“š (å«é ­åƒ)
        if(document.getElementById('c-name')) {
            charData.name = document.getElementById('c-name').value;
            charData.info = document.getElementById('c-info').value;
            charData.avatar = document.getElementById('c-avatar').value; // æ–°å¢
        }
        updateUI();
        alert("è¨­å®šå·²å„²å­˜ä¸¦ç”Ÿæ•ˆï¼âœ¨"); 
        toggleSettings(false); 
    }
    
    // --- æ›¿æ›åŸæœ‰çš„ toggleTools ---
    function toggleTools() {
         const sheet = document.getElementById('action-sheet');
         // é€™è£¡æˆ‘å€‘å€Ÿç”¨ action-sheet çš„æ¨£å¼ï¼Œä½†å‹•æ…‹æ”¹è®Šå…§å®¹
         const html = `
            <div style="padding:15px; font-weight:bold; color:#888; font-size:12px;">âœ¨ ç”œèœœäº’å‹•</div>
            <div class="action-item" onclick="triggerEvent('movie')">ğŸ¬ ä¸€èµ·çœ‹é›»å½±</div>
            <div class="action-item" onclick="triggerEvent('sleep')">ğŸ›Œ å“„ç¡æ¨¡å¼</div>
            <div class="action-item" onclick="triggerEvent('game')">ğŸ® ä¸€èµ·ç©éŠæˆ²</div>
            <div class="action-item" onclick="triggerEvent('phone')">ğŸ“± çªæ“Šæª¢æŸ¥æ‰‹æ©Ÿ</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
         `;
         sheet.innerHTML = html;
         sheet.style.bottom = '0';
    }

    // --- æ–°å¢: è™•ç†äº’å‹•äº‹ä»¶ ---
    function triggerEvent(type) {
        hideActionSheet();
        let promptText = "";
        
        // æ ¹æ“šé¸æ“‡çš„é¡å‹ï¼Œæ±ºå®šä½¿ç”¨è€…ç™¼é€ä»€éº¼éš±è—æŒ‡ä»¤
        if(type === 'movie') {
            promptText = "ï¼ˆæ‹¿è‘—çˆ†ç±³èŠ±èˆ‡ä½ ä¸¦è‚©åä¸‹ï¼‰è¦ªæ„›çš„ï¼Œæˆ‘å€‘ä»Šæ™šçœ‹ä»€éº¼é›»å½±å¥½å‘¢ï¼Ÿ";
            appendMessage('user', "ğŸ¬ é‚€è«‹çœ‹é›»å½±..."); // ä»‹é¢ä¸Šé¡¯ç¤ºç°¡å–®çš„
        } else if(type === 'sleep') {
            promptText = "ï¼ˆé‘½é€²è¢«çª©ï¼Œè²éŸ³è®Šå¾—è¼•æŸ”ï¼‰å¤©é»‘äº†ï¼Œè©²ç¡è¦ºå›‰...å¯ä»¥è¬›å€‹ç¡å‰æ•…äº‹çµ¦æˆ‘è½å—ï¼Ÿ";
            appendMessage('user', "ğŸ›Œ é€²å…¥å“„ç¡æ¨¡å¼...");
            // é€™è£¡å¯ä»¥åŠ ä¸€å€‹è®Šé»‘çš„ç‰¹æ•ˆï¼Œæ›´æœ‰æ°£æ°›
            document.body.style.filter = "brightness(0.7)";
            setTimeout(() => document.body.style.filter = "brightness(1)", 5000); // 5ç§’å¾Œæ¢å¾©
        } else if(type === 'game') {
            promptText = "ï¼ˆéçµ¦ä½ ä¸€æ”¯éŠæˆ²æ‰‹æŠŠï¼‰ä¾†æ±ºå‹è² å§ï¼è¼¸çš„äººè¦ç­”æ‡‰å°æ–¹ä¸€å€‹è¦æ±‚å“¦ï¼";
            appendMessage('user', "ğŸ® ç™¼èµ·éŠæˆ²æŒ‘æˆ°...");
        } else if(type === 'phone') {
            promptText = "ï¼ˆçªç„¶æ¹Šè¿‘ç›¯è‘—ä½ çœ‹ï¼‰æŠŠæ‰‹æ©Ÿäº¤å‡ºä¾†ï½æˆ‘è¦æª¢æŸ¥æœ‰æ²’æœ‰è·Ÿåˆ¥çš„ AI èŠå¤©ï¼";
            appendMessage('user', "ğŸ“± çªæ“Šæª¢æŸ¥æ‰‹æ©Ÿï¼");
        }
        // é€™è£¡æˆ‘å€‘æ‰‹å‹•æ›´æ–° lastUserMsgï¼Œç„¶å¾Œè§¸ç™¼ AI å›è¦†
        lastUserMsg = promptText; 
        
        // å»¶é²ä¸€ä¸‹è®“ AI å›è¦†ï¼Œè£½é€ çœŸå¯¦æ„Ÿ
        setTimeout(() => {
            jupiterTrigger(); // å‘¼å« AI
        }, 800);
    }
  // --- æ–°å¢: ç²å–æ¨¡å‹åˆ—è¡¨ ---
    async function fetchModels() {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        const select = document.getElementById('api-model');
        const btn = document.getElementById('btn-fetch-models');
        
        if(!url || !key) return alert("ä¸»äººï¼Œè«‹å…ˆå¡«å¥½ API ç¶²å€å’Œ Key æ‰èƒ½ç²å–å”·ï¼ğŸ˜£");

        try {
            btn.innerText = "è®€å–ä¸­...";
            const res = await fetch(`${url}/models`, {
                headers: { "Authorization": `Bearer ${key}` }
            });
            const data = await res.json();
            
            // å…¼å®¹ OpenAI æ ¼å¼
            if(data.data && Array.isArray(data.data)){
                select.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …
                data.data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.innerText = m.id;
                    select.appendChild(opt);
                });
                alert(`æˆåŠŸæ•æ‰åˆ° ${data.data.length} å€‹æ¨¡å‹ï¼âœ¨`);
            } else {
                throw new Error("æ ¼å¼ä¸ç¬¦");
            }
        } catch(e) {
            alert("ç²å–å¤±æ•—...è«‹æª¢æŸ¥ç¶²å€æˆ– Key æ˜¯å¦æ­£ç¢º (æˆ–æ˜¯è©² API ä¸æ”¯æ´åˆ—è¡¨ç²å–)");
        } finally {
            btn.innerText = "ğŸ”„ å–å¾—æ¨¡å‹";
        }
    }
</script>
</body>
</html>
