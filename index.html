<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å¥³é¢¨æ¨¡æ“¬æ‰‹æ©Ÿ - åŠŸèƒ½å®Œå…¨é«”</title>
    <style>
        :root {
            --primary-pink: #ffafcc;
            --light-pink: #ffc2d1;
            --accent-pink: #fb6f92;
            --bg-color: #fff0f3;
            --text-color: #5c5c5c;
            --price-red: #ff4d4f;
        }

        body { background: #ffe5ec; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }

        /* iPhone æ¡†æ¶ */
        .iphone-frame { width: 375px; height: 760px; background: #333; border-radius: 55px; padding: 12px; box-shadow: 0 50px 100px rgba(0,0,0,0.3); position: relative; }
        .phone { width: 100%; height: 100%; background: white; border-radius: 43px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .notch { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 30px; background: black; border-radius: 20px; z-index: 5000; }

        /* é ‚éƒ¨æ¨™é¡Œèˆ‡å¥½æ„Ÿåº¦ */
        .header { background: var(--primary-pink); color: white; padding: 45px 25px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .tab-bar { display: flex; background: white; border-bottom: 1px solid #eee; z-index: 10; }
        .tab-item { flex: 1; text-align: center; padding: 12px; font-size: 14px; cursor: pointer; color: #888; }
        .tab-item.active { color: var(--accent-pink); font-weight: bold; border-bottom: 2px solid var(--accent-pink); }

        .content-view { flex: 1; overflow-y: auto; display: none; background: var(--bg-color); }
        .content-view.active { display: block; }

        /* èŠå¤©æ°£æ³¡ */
        .chat-area { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg-row { display: flex; gap: 8px; align-items: flex-start; transition: 0.3s; position: relative; }
        .msg-row.user-row { flex-direction: row-reverse; }
        .select-box { width: 0; overflow: hidden; display: flex; align-items: center; transition: 0.3s; }
        .delete-mode .select-box { width: 30px; }
        .bubble { max-width: 68%; padding: 12px 14px; border-radius: 20px; font-size: 14px; word-wrap: break-word; cursor: pointer; user-select: none; position: relative; }
        .bubble.ai { background: white; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--primary-pink); color: white; border-bottom-right-radius: 4px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background-size: cover; background-color: var(--light-pink); cursor: pointer; flex-shrink: 0; }
        
        /* è¡¨æƒ…é¢æ¿ */
        #emoji-panel {
            position: absolute; bottom: -380px; left: 0; width: 100%; height: 350px;
            background: white; border-top-left-radius: 25px; border-top-right-radius: 25px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 8000;
            transition: bottom 0.3s ease; display: flex; flex-direction: column;
        }
        .e-tabs { display: flex; background: #f9f9f9; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .e-tab { flex: 1; padding: 12px; text-align: center; font-size: 12px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
        .e-tab.active { color: var(--accent-pink); border-bottom-color: var(--accent-pink); font-weight: bold; }
        .e-content { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; align-content: start; }
        .emoji-item { font-size: 26px; text-align: center; cursor: pointer; }
        .kao-item { grid-column: span 3; font-size: 13px; background: #fff0f3; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; }
        .st-item { grid-column: span 2; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .st-img { width: 100%; height: 60px; object-fit: cover; border-radius: 8px; background: #eee; }
        .emoji-section-title { grid-column: 1 / 8; font-size: 11px; color: #aaa; margin: 10px 0 5px; }

        /* å•†åŸè¦–åœ– */
        .mall-user-info { display: flex; align-items: center; padding: 12px 15px; background: white; gap: 10px; border-bottom: 1px solid #eee; }
        .mall-sub-nav { display: flex; gap: 8px; padding: 10px; background: white; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #eee; }
        .category-btn { padding: 5px 12px; background: #fff0f3; border-radius: 15px; font-size: 11px; cursor: pointer; }
        .category-btn.active { background: var(--primary-pink); color: white; }
        .mall-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .product-card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .product-img { width: 100%; height: 100px; background: #fffafa; display: flex; justify-content: center; align-items: center; font-size: 40px; }
        .product-info { padding: 10px; }
        .buy-btn { width: 100%; background: linear-gradient(45deg, #ff9000, #ff5000); color: white; border: none; border-radius: 20px; padding: 6px; cursor: pointer; font-size: 11px; }

        /* è¨­å®šé¢æ¿ */
        #settings-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9000; display: none; flex-direction: column; }
        .settings-header { display: flex; align-items: center; padding: 45px 15px 15px; border-bottom: 1px solid #eee; }
        .settings-tabs { display: flex; background: #f9f9f9; }
        .s-tab { flex: 1; padding: 10px; text-align: center; font-size: 11px; cursor: pointer; border-bottom: 1px solid #ddd; }
        .s-tab.active { border-bottom: 2px solid var(--accent-pink); color: var(--accent-pink); font-weight: bold; }
        .s-content { padding: 15px; flex: 1; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ffdae0; border-radius: 12px; box-sizing: border-box; outline: none; }
        textarea { width: 100%; height: 100px; border: 1px solid #ffdae0; border-radius: 12px; padding: 10px; font-size: 12px; resize: none; box-sizing: border-box; }

        /* åº•éƒ¨ */
        .footer-container { background: #fff; border-top: 1px solid #eee; padding-bottom: 25px; transition: 0.3s; }
        .footer { padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        input#msg-input { flex: 1; border: none; background: #f0f0f0; border-radius: 20px; padding: 10px 15px; outline: none; }
        #action-sheet { 
    position: absolute; 
    bottom: 0; /* æ”¹æˆ 0ï¼Œè®“å®ƒè²¼é½Šåº•éƒ¨ */
    left: 0; 
    width: 100%; 
    background: white; 
    border-top-left-radius: 25px; 
    border-top-right-radius: 25px; 
    z-index: 9500; 
    display: flex; 
    flex-direction: column; 
    transition: transform 0.3s ease; /* æ”¹ç”¨ transform å‹•ç•« */
    padding-bottom: 30px; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
    transform: translateY(100%); /* é—œéµï¼šå¾€ä¸‹ç§»å‹•è‡ªèº«é«˜åº¦çš„ 100% (å®Œå…¨éš±è—) */
}
        .action-item { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 15px; }
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 120px; height: 5px; background: #ccc; border-radius: 10px; }

        /* --- æ–°å¢: è¬èƒ½ APP è¦–çª—æ¨£å¼ --- */
        .app-modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .app-modal-overlay.open { display: flex; opacity: 1; }
        .app-window {
            width: 85%; height: 70%; 
            background: white; border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .app-modal-overlay.open .app-window { transform: scale(1); }
        .app-header {
            background: var(--primary-pink); color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 14px;
        }
        .app-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffafa; }
        .close-btn { cursor: pointer; font-size: 18px; }

    </style>
</head>
<body>

<div class="iphone-frame">
    <div class="notch"></div>
    <div class="phone">
        <div class="header">
            <div style="width: 20px;"></div> 
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span id="display-char-name" style="font-size: 15px;">ğŸ€ AI å°ç”œå¿ƒ</span>
                <div style="font-size: 10px; margin-top: 2px; opacity: 0.9; font-weight: normal;">
                    ğŸ’– <span id="header-favor">520</span>
                </div>
            </div>
            <div onclick="toggleSettings(true)" style="cursor:pointer; font-size: 18px;">âš™ï¸</div>
        </div>

        <div class="tab-bar">
            <div class="tab-item active" onclick="switchView('chat', this)">æ¶ˆæ¯</div>
            <div class="tab-item" onclick="switchView('mall', this)">å•†åŸ</div>
        </div>
        
        <div id="view-chat" class="content-view active" onclick="closePopups()">
            <div class="chat-area" id="chat"></div>
        </div>

        <div id="view-mall" class="content-view">
            <div class="mall-user-info">
                <div class="avatar avatar-user" style="width:35px; height:35px;"></div>
                <div style="flex:1; font-size:12px; margin-left: 10px;">
                    <div style="display: flex; align-items: center;">
                        <b id="display-user-name">å¹¸é‹å°ä¸»</b>
                        <span onclick="filterMall('bag', null)" style="cursor:pointer; margin-left: 5px; font-size: 14px;" title="æˆ‘çš„èƒŒåŒ…">ğŸ’</span>
                    </div>
                    <div style="margin-top: 2px;">é¤˜é¡: <span id="mall-balance" style="color:var(--price-red);">1000</span></div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="aiAddNewProducts(null)" style="background: white; color: var(--accent-pink); border: 1px solid var(--accent-pink); border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">âœ¨ ä¸Šæ–°</button>
                    <button onclick="aiAutoShop()" style="background:var(--accent-pink); color:white; border:none; border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">è®“ Ta é¸è³¼</button>
                </div>
            </div>
            <div class="mall-sub-nav">
                <div class="category-btn active" onclick="filterMall('all', this)">ğŸ“¦ å…¨éƒ¨</div>
                <div class="category-btn" onclick="filterMall('food', this)">ğŸ¦ é£Ÿç‰©</div>
                <div class="category-btn" onclick="filterMall('cloth', this)">ğŸ‘— è¡£æœ</div>
            </div>
            <div class="mall-grid" id="mall-display"></div>
        </div>

        <div id="emoji-panel" onclick="event.stopPropagation()">
            <div class="e-tabs">
                <div class="e-tab active" onclick="switchETab(0)">Emoji</div>
                <div class="e-tab" onclick="switchETab(1)">é¡æ–‡å­—</div>
                <div class="e-tab" onclick="switchETab(2)">AIè¡¨æƒ…åº«</div>
            </div>
            <div id="emoji-content" class="e-content"></div>
        </div>

        <div id="app-modal" class="app-modal-overlay">
            <div class="app-window">
                <div class="app-header">
                    <span id="app-title">æ‡‰ç”¨ç¨‹å¼</span>
                    <span class="close-btn" onclick="closeApp()">âœ–</span>
                </div>
                <div id="app-content" class="app-body"></div>
            </div>
        </div>

        <div id="settings-panel">
            <div class="settings-header">
                <div onclick="toggleSettings(false)" style="color:var(--accent-pink); cursor:pointer; font-weight:bold;">ï¼œ è¿”å›</div>
                <div style="flex:1; text-align:center; font-weight:bold; margin-right:30px;">è¨­å®šä¸­å¿ƒ</div>
            </div>
            <div class="settings-tabs">
                <div class="s-tab active" onclick="switchSTab(0)">API</div>
                <div class="s-tab" onclick="switchSTab(1)">Useräººè¨­</div>
                <div class="s-tab" onclick="switchSTab(2)">Charäººè¨­</div>
                <div class="s-tab" onclick="switchSTab(3)">ä¸–ç•Œæ›¸</div>
            </div>
            <div class="s-content" id="s-content-box"></div>
            <div style="padding:15px; border-top:1px solid #eee;">
                <button onclick="saveAllSettings()" style="width:100%; background:var(--accent-pink); color:white; border:none; border-radius:15px; padding:12px; font-weight:bold;">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div class="footer-container" id="footer-group">
            <div class="footer">
                <div class="icon-btn" onclick="toggleEmoji(event)">ğŸ˜Š</div>
                <input type="text" id="msg-input" placeholder="å‚³é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') userSubmit()">
                <div class="icon-btn" onclick="toggleTools()">â•</div>
                <button style="background:transparent; border:none; font-size:28px; cursor:pointer;" onclick="jupiterTrigger()">ğŸª</button>
            </div>
            <div class="home-indicator"></div>
        </div>

        <div id="action-sheet">
            <div class="action-item" onclick="editCurrentMsg()">ç·¨è¼¯</div>
            <div class="action-item" id="regen-btn" onclick="regenCurrentMsg()">é‡æ–°ç”Ÿæˆ</div>
            <div class="action-item" onclick="enterDeleteMode()">å¤šé¸åˆªé™¤</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
        </div>
    </div>
</div>

<script>
    // --- æ•¸æ“šç‹€æ…‹ ---
    let balance = 1000, favor = 520, lastUserMsg = "", stickerLib = JSON.parse(localStorage.getItem('stickerLib') || '[]');
    let inventory = []; 
    let currentTargetId = null;
    let timer = null;
    
    // é è¨­æ•¸æ“š
    let userData = { name: "å¹¸é‹å°ä¸»", info: "å–œæ­¡å¯æ„›æ±è¥¿çš„æ—…è¡Œè€…ã€‚", avatar: "" };
    let charData = { name: "AI å°ç”œå¿ƒ", info: "æ´»æ½‘é–‹æœ—ï¼Œä¾è³´ä¸»äººçš„å°‘å¥³ã€‚", avatar: "" };
    let products = [{id:1, name:"è‰è“å¤§å¹…", price:25, icon:"ğŸ¡", cat:"food"}, {id:2, name:"èŒèŒå¥³åƒ•è£", price:450, icon:"ğŸ‘—", cat:"cloth"}];
    
    // è¡¨æƒ…åº«
    const emojiFaces = ["ğŸ˜Š","ğŸ˜ƒ","ğŸ¤£","ğŸ˜‡","ğŸ˜‹","ğŸ§","ğŸ¥³","ğŸ˜","ğŸ˜”","ğŸ¥º","ğŸ¥µ","ğŸ¤¯"];
    const emojiFood = ["ğŸ“","ğŸ°","ğŸ¨","ğŸ§‹","â˜•","ğŸ¬"];
    const kaomojis = ["(âœ¿â—¡â€¿â—¡)", "(Â´â–½`Êƒâ™¡Æª)", "(ï½¡â™¥â€¿â™¥ï½¡)", "o(*^â–½^*)o", "(>_<)", "(OwO)"];

    // åˆå§‹åŒ–
    window.onload = () => { 
        loadAll(); 
        updateUI(); 
        switchETab(0); 
        switchSTab(0); 
        filterMall('all', document.querySelector('.category-btn')); 
        appendMessage('ai', "ä¸»äººï¼è¬èƒ½ APP è¦–çª—ç³»çµ±ä¸Šç·šå•¦ï¼è©¦è©¦çœ‹é»æ“Š â• è™Ÿå§ï¼ğŸ“±âœ¨"); 
    };

    // --- è¦–åœ–èˆ‡ä»‹é¢æ§åˆ¶ ---
    function switchView(view, el) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active'); 
        if(el) el.classList.add('active');
        document.getElementById('footer-group').style.display = (view === 'chat') ? 'block' : 'none';
    }

    function toggleSettings(s) { document.getElementById('settings-panel').style.display = s ? 'flex' : 'none'; }

    // --- è¨­å®šåˆ†é é‚è¼¯ ---
    function switchSTab(idx) {
        const box = document.getElementById('s-content-box');
        document.querySelectorAll('.s-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        
        if(idx === 0) {
            box.innerHTML = `
                <div class="input-group"><label>API Base URL</label><input id="api-url" value="${localStorage.getItem('apiUrl') || 'https://api.openai.com/v1'}"></div>
                <div class="input-group"><label>API Key</label><input type="password" id="api-key" value="${localStorage.getItem('apiKey') || ''}"></div>
                <div class="input-group">
                    <label>æ¨¡å‹é¸æ“‡</label>
                    <div style="display:flex; gap:5px;">
                        <select id="api-model" style="flex:1;">
                            <option value="${localStorage.getItem('apiModel') || 'gpt-3.5-turbo'}">${localStorage.getItem('apiModel') || 'gpt-3.5-turbo (ç•¶å‰)'}</option>
                        </select>
                        <button id="btn-fetch-models" onclick="fetchModels()" style="padding:0 10px; border:1px solid #ffafcc; background:white; border-radius:10px; cursor:pointer;">ğŸ”„ å–å¾—æ¨¡å‹</button>
                    </div>
                </div>`;
        } else if(idx === 1) {
            box.innerHTML = `
                <div class="input-group"><label>User åå­—</label><input id="u-name" value="${userData.name}"></div>
                <div class="input-group"><label>User é ­åƒ (URL)</label><input id="u-avatar" value="${userData.avatar || ''}" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ..."></div>
                <div class="input-group"><label>è¨­å®š / å‚™å¿˜éŒ„</label><textarea id="u-info">${userData.info}</textarea></div>`;
        } else if(idx === 2) {
            box.innerHTML = `
                <div class="input-group"><label>AI åå­—</label><input id="c-name" value="${charData.name}"></div>
                <div class="input-group"><label>AI é ­åƒ (URL)</label><input id="c-avatar" value="${charData.avatar || ''}" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ..."></div>
                <div class="input-group"><label>AI äººè¨­</label><textarea id="c-info">${charData.info}</textarea></div>`;
        } else if(idx === 3) {
            box.innerHTML = `<input type="file" id="wb-upload" onchange="importWB(event)"><p style="font-size:10px; color:#888; margin-top:10px;">æ”¯æ´å°å…¥ JSON æ ¼å¼çš„ä¸–ç•Œæ›¸æˆ–è¨­å®šæª”ã€‚</p>`;
        }
    }

    // --- ä¸–ç•Œæ›¸èˆ‡æ¨¡å‹ç²å– ---
    function importWB(event) {
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                localStorage.setItem('world_book', JSON.stringify(json));
                alert("ğŸ“– ä¸–ç•Œæ›¸å°å…¥æˆåŠŸï¼å·²å­˜å…¥è¨˜æ†¶åº«ã€‚");
            } catch(err) {
                alert("âŒ æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä¸Šå‚³æ­£ç¢ºçš„ JSON æ–‡æª”ã€‚");
            }
        };
        reader.readAsText(file);
    }

    async function fetchModels() {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        const select = document.getElementById('api-model');
        const btn = document.getElementById('btn-fetch-models');
        
        if(!url || !key) return alert("ä¸»äººï¼Œè«‹å…ˆå¡«å¥½ API ç¶²å€å’Œ Key æ‰èƒ½ç²å–å”·ï¼ğŸ˜£");

        try {
            btn.innerText = "è®€å–ä¸­...";
            const res = await fetch(`${url}/models`, { headers: { "Authorization": `Bearer ${key}` } });
            const data = await res.json();
            if(data.data && Array.isArray(data.data)){
                select.innerHTML = ''; 
                data.data.forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.id; opt.innerText = m.id; select.appendChild(opt);
                });
                alert(`æˆåŠŸæ•æ‰åˆ° ${data.data.length} å€‹æ¨¡å‹ï¼âœ¨`);
            } else { throw new Error("æ ¼å¼ä¸ç¬¦"); }
        } catch(e) { alert("ç²å–å¤±æ•—...è«‹æª¢æŸ¥ç¶²å€æˆ– Key"); } finally { btn.innerText = "ğŸ”„ å–å¾—æ¨¡å‹"; }
    }

    // --- è¡¨æƒ…èˆ‡è²¼åœ–é‚è¼¯ ---
    function switchETab(idx) {
        const content = document.getElementById('emoji-content');
        document.querySelectorAll('.e-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        content.innerHTML = ''; content.className = 'e-content';
        if(idx === 0) {
            addESec(content, "è¡¨æƒ…èˆ‡äººç‰©", emojiFaces); addESec(content, "é£Ÿç‰©é¡", emojiFood);
        } else if(idx === 1) {
            content.classList.add('kaomoji');
            kaomojis.forEach(k => {
                const d = document.createElement('div'); d.className = 'kao-item'; d.innerText = k; d.onclick = () => { document.getElementById('msg-input').value += k; }; content.appendChild(d);
            });
        } else if(idx === 2) {
            content.classList.add('stickers');
            content.innerHTML = `<button onclick="uploadSticker()" style="grid-column:span 4; margin-bottom:10px; border:1px dashed #ccc; background:white; border-radius:10px; color:#888;">+ ä¸Šå‚³æ–°è²¼åœ–</button>`;
            stickerLib.forEach(s => {
                const d = document.createElement('div'); d.className = 'st-item';
                d.innerHTML = `<img src="${s.url}" class="st-img"><span style="font-size:9px;">${s.name}</span>`;
                d.onclick = () => sendStickerLabel(s.name); content.appendChild(d);
            });
        }
    }
    function addESec(c, t, l) {
        const h = document.createElement('div'); h.className = 'emoji-section-title'; h.innerText = t; c.appendChild(h);
        l.forEach(e => { const s = document.createElement('span'); s.className = 'emoji-item'; s.innerText = e; s.onclick = () => { document.getElementById('msg-input').value += e; }; c.appendChild(s); });
    }

    // --- è¨Šæ¯ç®¡ç† ---
    function appendMessage(role, content) {
        const chat = document.getElementById('chat'); const id = 'msg-' + Date.now(); const row = document.createElement('div');
        row.className = `msg-row ${role === 'user' ? 'user-row' : ''}`; row.id = id;
        row.innerHTML = `<div class="select-box"><input type="checkbox"></div><div class="avatar avatar-${role}" ondblclick="nudge()"></div><div class="bubble ${role}">${parseSticker(content)}</div>`;
        
        const avatarUrl = role === 'user' ? (userData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky') : (charData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee');
        row.querySelector('.avatar').style.backgroundImage = `url('${avatarUrl}')`;

        row.onmousedown = () => { timer = setTimeout(() => showAction(id, role), 600); }; 
        row.onmouseup = () => clearTimeout(timer);
        row.ontouchstart = () => { timer = setTimeout(() => showAction(id, role), 600); };
        row.ontouchend = () => clearTimeout(timer);
        chat.appendChild(row); document.getElementById('view-chat').scrollTop = document.getElementById('view-chat').scrollHeight;
    }
    
    function parseSticker(t) { return t.replace(/\[è¡¨æƒ…:\s*(.+?)\]/g, (m, n) => { const s = stickerLib.find(x => x.name === n); return s ? `<img src="${s.url}" style="max-width:130px; border-radius:10px; display:block; margin:5px 0;">` : m; }); }
    function nudge() { appendMessage('ai', `å“å‘€ï¼ä¸è¦æ‹æ‹æˆ‘å•¦ï½ğŸŒ¸`); }

    // æ¶ˆæ¯æ“ä½œåŠŸèƒ½
    // 1. é¡¯ç¤ºæ“ä½œé¸å–® (é•·æŒ‰æ°£æ³¡æ™‚)
    function showAction(id, role) { 
        currentTargetId = id; 
        // ä¿®æ”¹: æ”¹æˆæ­¸é›¶ transformï¼Œé¸å–®å°±æœƒæ»‘ä¸Šä¾†
        document.getElementById('action-sheet').style.transform = 'translateY(0)'; 
    }
    // 2. éš±è—é¸å–® (æ ¸å¿ƒä¿®å¾©)
    function hideActionSheet() { 
        // ä¿®æ”¹: æ”¹æˆå¾€ä¸‹ç§»å‹• 100%ï¼Œä¸ç®¡é¸å–®å¤šé•·éƒ½æœƒå®Œå…¨ç¸®å›å»
        document.getElementById('action-sheet').style.transform = 'translateY(100%)'; 
    }
    function editCurrentMsg() {
        if(!currentTargetId) return;
        const bubble = document.getElementById(currentTargetId).querySelector('.bubble');
        const newTxt = prompt("ç·¨è¼¯æ¶ˆæ¯ï¼š", bubble.innerText);
        if(newTxt) bubble.innerText = newTxt;
        hideActionSheet();
    }
    function regenCurrentMsg() {
        const chat = document.getElementById('chat');
        if(chat.lastChild && chat.lastChild.querySelector('.avatar-ai')) {
            chat.removeChild(chat.lastChild);
            jupiterTrigger(); 
        }
        hideActionSheet();
    }
    function enterDeleteMode() {
        document.body.classList.add('delete-mode');
        alert("å·²é€²å…¥åˆªé™¤æ¨¡å¼ (æ¼”ç¤ºç”¨)");
        hideActionSheet();
        setTimeout(() => document.body.classList.remove('delete-mode'), 3000);
    }

    // --- å•†åŸé‚è¼¯ ---
    function filterMall(cat, el) {
        if(el) { document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
        const display = document.getElementById('mall-display'); display.innerHTML = '';
        const f = cat === 'all' ? products : (cat === 'bag' ? inventory : products.filter(p => p.cat === cat));
        f.forEach((p, idx) => {
            display.innerHTML += `<div class="product-card"><div class="product-img">${p.icon}</div><div class="product-info"><div style="font-size:11px;">${p.name}</div><div style="color:red; font-weight:bold;">Â¥${p.price || '--'}</div><button class="buy-btn" onclick="${cat==='bag'?'useItem('+idx+')':'buyProd('+p.id+')'}">${cat==='bag'?'ä½¿ç”¨':'è³¼è²·'}</button></div></div>`;
        });
    }
    function aiAutoShop() {
        const item = products[Math.floor(Math.random() * products.length)];
        if(balance >= item.price) { balance -= item.price; inventory.push(item); updateUI(); alert(`AI è‡ªå·±è²·äº† ${item.name}ï¼å¥½é–‹å¿ƒï¼âœ¨`); } else { alert("å—šå—šï¼Œé¤˜é¡ä¸è¶³..."); }
    }
    function aiAddNewProducts(el) { filterMall('all', el); alert("âœ¨ é­”æ³•åˆ·æ–°ï¼å•†åŸè²¨æ¶æ•´ç†ä¸­..."); }

    // --- å­˜æª”èˆ‡åˆå§‹åŒ– ---
    function loadAll() {
        const u = localStorage.getItem('userData'), c = localStorage.getItem('charData'), inv = localStorage.getItem('inventory');
        if(u) userData = JSON.parse(u); if(c) charData = JSON.parse(c); if(inv) inventory = JSON.parse(inv);
    }
    function updateUI() {
        document.getElementById('header-favor').innerText = favor; document.getElementById('mall-balance').innerText = balance;
        document.getElementById('display-char-name').innerText = "ğŸ€ " + charData.name; document.getElementById('display-user-name').innerText = userData.name;
        
        const defaultUser = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky';
        const defaultChar = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee';
        const userUrl = userData.avatar || defaultUser;
        const charUrl = charData.avatar || defaultChar;

        document.querySelectorAll('.avatar-user').forEach(el => el.style.backgroundImage = `url('${userUrl}')`);
        document.querySelectorAll('.avatar-ai').forEach(el => el.style.backgroundImage = `url('${charUrl}')`);

        localStorage.setItem('userData', JSON.stringify(userData));
        localStorage.setItem('charData', JSON.stringify(charData));
        localStorage.setItem('inventory', JSON.stringify(inventory));
    }

    // --- APP è¦–çª—æ§åˆ¶ç³»çµ± ---
    function openApp(appName, htmlContent) {
        const modal = document.getElementById('app-modal');
        document.getElementById('app-title').innerText = appName;
        document.getElementById('app-content').innerHTML = htmlContent;
        modal.classList.add('open');
    }

    function closeApp() {
        const modal = document.getElementById('app-modal');
        modal.classList.remove('open');
        setTimeout(() => { document.getElementById('app-content').innerHTML = ''; }, 300);
    }

    // --- æ ¸å¿ƒé‚è¼¯ (å·¥å…·ã€APIã€è¨˜æ†¶) ---
    function toggleEmoji(e) { e.stopPropagation(); const p = document.getElementById('emoji-panel'); p.style.bottom = p.style.bottom === '0px' ? '-380px' : '0px'; }
    function closePopups() { document.getElementById('emoji-panel').style.bottom = '-380px'; hideActionSheet(); }
    
    function userSubmit() { 
        const i = document.getElementById('msg-input'); 
        if(i.value.trim()){ 
            appendMessage('user', i.value); 
            lastUserMsg = i.value; 
            i.value = ''; 
            closePopups(); 
        } 
    }

    function getChatHistory() {
        const rows = document.querySelectorAll('.msg-row');
        let history = [];
        const start = Math.max(0, rows.length - 15);
        for (let i = start; i < rows.length; i++) {
            const row = rows[i];
            if (row.querySelector('.bubble').innerText === 'è¼¸å…¥ä¸­...') continue;
            const isUser = row.classList.contains('user-row');
            const text = row.querySelector('.bubble').innerText;
            history.push({ role: isUser ? "user" : "assistant", content: text });
        }
        return history;
    }

    async function jupiterTrigger() {
        const apiKey = document.getElementById('api-key')?.value || localStorage.getItem('apiKey');
        const apiUrl = document.getElementById('api-url')?.value || "https://api.openai.com/v1";
        const model = document.getElementById('api-model')?.value || localStorage.getItem('apiModel') || "gpt-3.5-turbo";
        
        const tempId = 'thinking-' + Date.now();
        const chat = document.getElementById('chat');
        const loadingRow = document.createElement('div');
        loadingRow.className = 'msg-row'; loadingRow.id = tempId;
        loadingRow.innerHTML = `<div class="avatar avatar-ai"></div><div class="bubble ai" style="color:#aaa; font-style:italic;">è¼¸å…¥ä¸­...</div>`;
        chat.appendChild(loadingRow);
        chat.scrollTop = chat.scrollHeight;

        if (!apiKey) {
            document.getElementById(tempId).remove();
            appendMessage('ai', "ä¸»äººï¼Œè«‹å…ˆåˆ°è¨­å®šè¼¸å…¥ API Key å“¦ï¼");
            return;
        }

        try {
            let wbPrompt = "";
            const wbData = localStorage.getItem('world_book');
            if(wbData) {
                try {
                    const json = JSON.parse(wbData);
                    wbPrompt = "\n[ä¸–ç•Œè§€è¨­å®š]:\n" + JSON.stringify(json);
                } catch(e) {}
            }

            const systemMsg = { 
                role: "system", 
                content: `${charData.name}çš„è¨­å®š: ${charData.info}ã€‚\nç”¨æˆ¶æ˜¯${userData.name}: ${userData.info}ã€‚\n${wbPrompt}\nè«‹æ‰®æ¼”è©²è§’è‰²ï¼Œç”¨å£èªåŒ–ã€å¯æ„›çš„èªæ°£å°è©±ã€‚` 
            };

            const history = getChatHistory();
            const messages = [systemMsg, ...history];

            const res = await fetch(`${apiUrl}/chat/completions`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: messages, temperature: 0.8 })
            });

            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Status: ${res.status}`);
            }

            const data = await res.json();
            document.getElementById(tempId).remove(); 
            if (data.choices && data.choices.length > 0) {
                appendMessage('ai', data.choices[0].message.content);
            } else { appendMessage('ai', "ï¼ˆæ²ˆé»˜ä¸èª...ï¼‰"); }
        } catch (e) {
            document.getElementById(tempId).remove();
            console.error(e);
            let errorMsg = e.message;
            if (e.name === 'TypeError' && e.message === 'Failed to fetch') errorMsg = "ç€è¦½å™¨é˜»æ“‹ (CORS)ï¼Œè«‹æ›ä»£ç†ç¶²å€";
            appendMessage('ai', `(å¤±æ•—) ${errorMsg}`);
        }
    }

    // 3. é¡¯ç¤ºå·¥å…·ç®± (é»æ“Š + è™Ÿæ™‚)
    function toggleTools() {
         const sheet = document.getElementById('action-sheet');
         const html = `
            <div style="padding:15px; font-weight:bold; color:#888; font-size:12px;">ğŸ“± æ‡‰ç”¨ä¸­å¿ƒ</div>
            <div class="action-item" onclick="openGameApp()">ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ (æ–°åŠŸèƒ½!)</div>
            <div class="action-item" onclick="triggerEvent('movie')">ğŸ¬ ä¸€èµ·çœ‹é›»å½±</div>
            <div class="action-item" onclick="openCalendarApp()">ğŸ“… æ—¥æ›†ç®¡ç† (é–‹ç™¼ä¸­)</div>
            <div class="action-item" onclick="triggerEvent('sleep')">ğŸ›Œ å“„ç¡æ¨¡å¼</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
         `;
         sheet.innerHTML = html;
         // ä¿®æ”¹: åŒæ¨£æ”¹æˆæ­¸é›¶ transform
         sheet.style.transform = 'translateY(0)'; 
    }

    function triggerEvent(type) {
        hideActionSheet();
        let promptText = "";
        if(type === 'movie') { promptText = "ï¼ˆæ‹¿è‘—çˆ†ç±³èŠ±åä¸‹ï¼‰è¦ªæ„›çš„ï¼Œçœ‹ä»€éº¼é›»å½±å¥½å‘¢ï¼Ÿ"; appendMessage('user', "ğŸ¬ é‚€è«‹çœ‹é›»å½±..."); }
        else if(type === 'sleep') { promptText = "ï¼ˆé‘½é€²è¢«çª©ï¼‰å¤©é»‘äº†ï¼Œè¬›å€‹æ•…äº‹çµ¦æˆ‘è½å˜›...ğŸ’¤"; appendMessage('user', "ğŸ›Œ é€²å…¥å“„ç¡æ¨¡å¼..."); document.body.style.filter = "brightness(0.7)"; setTimeout(() => document.body.style.filter = "brightness(1)", 5000); }
        lastUserMsg = promptText; 
        setTimeout(jupiterTrigger, 800);
    }
    
    // å®šç¾© APP å…§å®¹
    function openGameApp() {
        hideActionSheet();
        const petHtml = `
            <div style="text-align:center;">
                <div style="font-size:60px; margin:20px;">ğŸ£</div>
                <h3>é›»å­å°é›</h3>
                <p style="color:#888; font-size:12px;">å¥½æ„Ÿåº¦: ${favor}</p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                    <button onclick="alert('é¤µé£ŸæˆåŠŸï¼')" style="padding:10px; border-radius:10px; border:1px solid #eee; background:white;">ğŸ– é¤µé£Ÿ</button>
                    <button onclick="alert('æ‘¸æ‘¸é ­ï¼')" style="padding:10px; border-radius:10px; border:1px solid #eee; background:white;">ğŸ‘‹ æ’«æ‘¸</button>
                    <button onclick="alert('å»ç©è€ï¼')" style="padding:10px; border-radius:10px; border:1px solid #eee; background:white;">âš½ ç©è€</button>
                    <button onclick="alert('æ´—é¦™é¦™ï¼')" style="padding:10px; border-radius:10px; border:1px solid #eee; background:white;">ğŸ› æ´—æ¾¡</button>
                </div>
            </div>
        `;
        openApp("ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ", petHtml);
    }
    function openCalendarApp() {
        hideActionSheet();
        openApp("ğŸ“… è¡Œç¨‹æ—¥æ›†", "<p style='text-align:center; color:#ccc; margin-top:50px;'>æ—¥æ›†åŠŸèƒ½é–‹ç™¼ä¸­...</p>");
    }

    function uploadSticker() { 
        const n = prompt("è¡¨æƒ…åç¨±ï¼š"); if(!n) return;
        const i = document.createElement('input'); i.type = 'file'; i.onchange = (e) => {
            const r = new FileReader(); r.onload = (ev) => { stickerLib.push({name: n, url: ev.target.result}); localStorage.setItem('stickerLib', JSON.stringify(stickerLib)); switchETab(2); }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }
    function sendStickerLabel(n) { appendMessage('user', `[è¡¨æƒ…: ${n}]`); closePopups(); }
    function buyProd(id) { const p = products.find(x => x.id === id); if(balance >= p.price){ balance -= p.price; inventory.push(p); updateUI(); alert("å·²è³¼è²·"); } else { alert("é¤˜é¡ä¸è¶³ï¼"); } }
    function useItem(idx) { inventory.splice(idx, 1); updateUI(); filterMall('bag', null); alert("ä½¿ç”¨äº†ç‰©å“ï¼å¥½æ„Ÿåº¦ä¸Šå‡ï¼ğŸ’–"); favor+=10; updateUI(); }
    
    function saveAllSettings() { 
        if(document.getElementById('api-url')) {
            localStorage.setItem('apiUrl', document.getElementById('api-url').value);
            localStorage.setItem('apiKey', document.getElementById('api-key').value);
            localStorage.setItem('apiModel', document.getElementById('api-model').value);
        }
        if(document.getElementById('u-name')) {
            userData.name = document.getElementById('u-name').value;
            userData.info = document.getElementById('u-info').value;
            userData.avatar = document.getElementById('u-avatar').value;
        }
        if(document.getElementById('c-name')) {
            charData.name = document.getElementById('c-name').value;
            charData.info = document.getElementById('c-info').value;
            charData.avatar = document.getElementById('c-avatar').value;
        }
        updateUI(); alert("è¨­å®šå·²å„²å­˜ä¸¦ç”Ÿæ•ˆï¼âœ¨"); toggleSettings(false); 
    }
  // --- ğŸ£ å¯µç‰©ç³»çµ±æ ¸å¿ƒé‚è¼¯ ---
    
    // 1. å®šç¾©å¯µç‰©åˆå§‹æ•¸æ“š (å¦‚æœæ²’æœ‰å­˜æª”å°±ç”¨é€™å€‹)
    let petData = JSON.parse(localStorage.getItem('petData') || '{"level":1, "hunger":80, "mood":80, "exp":0}');

    // 2. å‡ç´šç‰ˆçš„é–‹å•Ÿè¦–çª—å‡½æ•¸
    function openGameApp() {
        hideActionSheet(); // é—œé–‰åº•éƒ¨é¸å–®
        updatePetUI(); // æ¸²æŸ“å¯µç‰©ç•«é¢
    }

    // 3. æ¸²æŸ“å¯µç‰©ç•«é¢ (æœƒæ ¹æ“šæ•¸æ“šå‹•æ…‹æ”¹è®Š)
    function updatePetUI() {
        // æ ¹æ“šå¿ƒæƒ…æ±ºå®šè¡¨æƒ…
        let petFace = "ğŸ£";
        if(petData.hunger < 30) petFace = "ğŸ˜µ (é¤“æšˆ)";
        else if(petData.mood < 30) petFace = "ğŸ˜­ (é›£é)";
        else if(petData.mood > 90) petFace = "ğŸ¥° (è¶…é–‹å¿ƒ)";
        
        const html = `
            <div style="text-align:center; padding:10px;">
                <div style="font-size:80px; margin:20px; animation: bounce 2s infinite;">${petFace}</div>
                <h3>é›»å­å°é› Lv.${petData.level}</h3>
                
                <div style="width:80%; margin:0 auto; text-align:left; font-size:12px; color:#666;">
                    é£½é£Ÿåº¦: ${petData.hunger}%
                    <div style="background:#eee; height:8px; border-radius:4px; margin-bottom:5px;">
                        <div style="background:#ffbd59; width:${petData.hunger}%; height:100%; border-radius:4px; transition:0.3s;"></div>
                    </div>
                    
                    å¿ƒæƒ…å€¼: ${petData.mood}%
                    <div style="background:#eee; height:8px; border-radius:4px; margin-bottom:15px;">
                        <div style="background:#ff91a4; width:${petData.mood}%; height:100%; border-radius:4px; transition:0.3s;"></div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                    <button onclick="interactPet('feed')" style="padding:15px; border-radius:15px; border:1px solid #eee; background:white; cursor:pointer;">
                        ğŸ— é¤µé£Ÿ <br><span style="font-size:10px; color:#aaa;">-10å…ƒ / +é£½é£Ÿ</span>
                    </button>
                    <button onclick="interactPet('play')" style="padding:15px; border-radius:15px; border:1px solid #eee; background:white; cursor:pointer;">
                        ğŸ¾ ç©è€ <br><span style="font-size:10px; color:#aaa;">+å¿ƒæƒ… / æ¶ˆè€—é£½é£Ÿ</span>
                    </button>
                    <button onclick="interactPet('clean')" style="padding:15px; border-radius:15px; border:1px solid #eee; background:white; cursor:pointer;">
                        ğŸ› æ´—æ¾¡ <br><span style="font-size:10px; color:#aaa;">æ¢å¾©å¿ƒæƒ…</span>
                    </button>
                    <button onclick="interactPet('work')" style="padding:15px; border-radius:15px; border:1px solid #eee; background:white; cursor:pointer;">
                        ğŸ’° æ‰“å·¥ <br><span style="font-size:10px; color:#aaa;">è³ºå–é›¶ç”¨éŒ¢</span>
                    </button>
                </div>
            </div>
            <style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>
        `;
        
        // ä½¿ç”¨æˆ‘å€‘ä¹‹å‰åšçš„è¬èƒ½è¦–çª—ç³»çµ±
        openApp("ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ", html);
    }

    // 4. å¯µç‰©äº’å‹•é‚è¼¯
    function interactPet(action) {
        if(action === 'feed') {
            if(balance < 10) return alert("éŒ¢åŒ…ç©ºç©ºï¼Œè²·ä¸èµ·é£¼æ–™äº†...ğŸ’¸");
            if(petData.hunger >= 100) return alert("å®ƒè‚šå­é£½é£½çš„ï¼Œåƒä¸ä¸‹äº†ï¼");
            balance -= 10;
            petData.hunger = Math.min(100, petData.hunger + 20);
            petData.mood = Math.min(100, petData.mood + 5);
            alert("èŠ±äº† 10å…ƒ è²·é£¼æ–™ï¼Œå°é›åƒå¾—å¾ˆé–‹å¿ƒï¼ğŸ—");
        } 
        else if(action === 'play') {
            if(petData.hunger < 20) return alert("å®ƒé¤“å¾—æ²’åŠ›æ°£ç©äº†...å…ˆé¤µé»æ±è¥¿å§ï¼");
            petData.mood = Math.min(100, petData.mood + 15);
            petData.hunger = Math.max(0, petData.hunger - 10); // ç©è€æœƒé¤“
            petData.exp += 10; // å¢åŠ ç¶“é©—å€¼
            alert("é™ªå®ƒç©äº†ä¸€æœƒå…’ï¼Œå¿ƒæƒ…è®Šå¥½äº†ï¼âœ¨");
        }
        else if(action === 'clean') {
            petData.mood = Math.min(100, petData.mood + 10);
            alert("æ´—å¾—é¦™å™´å™´çš„ï¼ğŸ›");
        }
        else if(action === 'work') {
            if(petData.mood < 30) return alert("å®ƒå¿ƒæƒ…ä¸å¥½ï¼Œä¸æƒ³å»æ‰“å·¥...ğŸ’¢");
            if(petData.hunger < 30) return alert("è‚šå­å¤ªé¤“äº†ï¼Œæ¬ä¸å‹•ç£š...ğŸ˜µ");
            petData.hunger -= 20;
            petData.mood -= 20;
            const wage = 50 + (petData.level * 5); // ç­‰ç´šè¶Šé«˜è³ºè¶Šå¤š
            balance += wage;
            petData.exp += 5;
            alert(`å°é›å»æ‰“å·¥å›ä¾†äº†ï¼è³ºåˆ°äº† ${wage} å…ƒï¼ğŸ’°`);
        }

        // æª¢æŸ¥å‡ç´š
        if(petData.exp > 100 * petData.level) {
            petData.level++;
            petData.exp = 0;
            alert(`ğŸ‰ æ­å–œï¼é›»å­å°é›å‡ç´šåˆ°äº† Lv.${petData.level}ï¼`);
        }

        // ä¿å­˜æ•¸æ“šä¸¦åˆ·æ–°ä»‹é¢
        savePetData();
        updatePetUI(); // é‡æ–°ç¹ªè£½ä»‹é¢é¡¯ç¤ºæ–°æ•¸å€¼
        updateUI(); // æ›´æ–°å¤–é¢çš„é¤˜é¡é¡¯ç¤º
    }

    // 5. ä¿å­˜æ•¸æ“š
    function savePetData() {
        localStorage.setItem('petData', JSON.stringify(petData));
    }
</script>
</body>
</html>
