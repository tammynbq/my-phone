<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å¥³é¢¨æ¨¡æ“¬æ‰‹æ©Ÿ - çµ‚æ¥µå®Œæ•´ç‰ˆ</title>
    <style>
        :root { --primary-pink: #ffafcc; --light-pink: #ffc2d1; --accent-pink: #fb6f92; --bg-color: #fff0f3; --text-color: #5c5c5c; --price-red: #ff4d4f; }
        body { background: #ffe5ec; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        
        /* æ‰‹æ©Ÿæ¡†æ¶ */
        .iphone-frame { width: 375px; height: 760px; background: #333; border-radius: 55px; padding: 12px; box-shadow: 0 50px 100px rgba(0,0,0,0.3); position: relative; }
        .phone { width: 100%; height: 100%; background: white; border-radius: 43px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .notch { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 30px; background: black; border-radius: 20px; z-index: 5000; }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        .header { background: var(--primary-pink); color: white; padding: 45px 20px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        
        /* é–‹é—œæ¨£å¼ */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-pink); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* å°èˆªèˆ‡è¦–åœ– */
        .tab-bar { display: flex; background: white; border-bottom: 1px solid #eee; z-index: 10; }
        .tab-item { flex: 1; text-align: center; padding: 12px; font-size: 14px; cursor: pointer; color: #888; }
        .tab-item.active { color: var(--accent-pink); font-weight: bold; border-bottom: 2px solid var(--accent-pink); }
        .content-view { flex: 1; overflow-y: auto; display: none; background: var(--bg-color); }
        .content-view.active { display: block; }

        /* èŠå¤©å®¤ */
        .chat-area { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg-row { display: flex; gap: 8px; align-items: flex-start; transition: 0.3s; position: relative; }
        .msg-row.user-row { flex-direction: row-reverse; }
        .select-box { width: 0; overflow: hidden; display: flex; align-items: center; transition: 0.3s; }
        .delete-mode .select-box { width: 30px; }
        .bubble { max-width: 68%; padding: 12px 14px; border-radius: 20px; font-size: 14px; word-wrap: break-word; cursor: pointer; user-select: none; position: relative; }
        .bubble.ai { background: white; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--primary-pink); color: white; border-bottom-right-radius: 4px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background-size: cover; background-color: var(--light-pink); cursor: pointer; flex-shrink: 0; }
        
        /* è¡¨æƒ…é¢æ¿ */
        #emoji-panel { position: absolute; bottom: -380px; left: 0; width: 100%; height: 350px; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 8000; transition: bottom 0.3s ease; display: flex; flex-direction: column; }
        .e-tabs { display: flex; background: #f9f9f9; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .e-tab { flex: 1; padding: 12px; text-align: center; font-size: 12px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
        .e-tab.active { color: var(--accent-pink); border-bottom-color: var(--accent-pink); font-weight: bold; }
        .e-content { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; align-content: start; }
        .emoji-item { font-size: 26px; text-align: center; cursor: pointer; }
        .kao-item { grid-column: span 3; font-size: 13px; background: #fff0f3; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; }
        .st-item { grid-column: span 2; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .st-img { width: 100%; height: 60px; object-fit: cover; border-radius: 8px; background: #eee; }
        .emoji-section-title { grid-column: 1 / 8; font-size: 11px; color: #aaa; margin: 10px 0 5px; }

        /* å•†åŸ */
        .mall-user-info { display: flex; align-items: center; padding: 12px 15px; background: white; gap: 10px; border-bottom: 1px solid #eee; }
        .mall-sub-nav { display: flex; gap: 8px; padding: 10px; background: white; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #eee; }
        .category-btn { padding: 5px 12px; background: #fff0f3; border-radius: 15px; font-size: 11px; cursor: pointer; }
        .category-btn.active { background: var(--primary-pink); color: white; }
        .mall-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .product-card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .product-img { width: 100%; height: 100px; background: #fffafa; display: flex; justify-content: center; align-items: center; font-size: 40px; }
        .product-info { padding: 10px; }
        .buy-btn { width: 100%; background: linear-gradient(45deg, #ff9000, #ff5000); color: white; border: none; border-radius: 20px; padding: 6px; cursor: pointer; font-size: 11px; }

        /* è¨­å®šé¢æ¿ */
        #settings-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9000; display: none; flex-direction: column; }
        .settings-header { display: flex; align-items: center; padding: 45px 15px 15px; border-bottom: 1px solid #eee; }
        .settings-tabs { display: flex; background: #f9f9f9; }
        .s-tab { flex: 1; padding: 10px; text-align: center; font-size: 11px; cursor: pointer; border-bottom: 1px solid #ddd; }
        .s-tab.active { border-bottom: 2px solid var(--accent-pink); color: var(--accent-pink); font-weight: bold; }
        .s-content { padding: 15px; flex: 1; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ffdae0; border-radius: 12px; box-sizing: border-box; outline: none; }
        textarea { width: 100%; height: 100px; border: 1px solid #ffdae0; border-radius: 12px; padding: 10px; font-size: 12px; resize: none; box-sizing: border-box; }

        /* åº•éƒ¨èˆ‡é¸å–® */
        .footer-container { background: #fff; border-top: 1px solid #eee; padding-bottom: 25px; transition: 0.3s; }
        .footer { padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        input#msg-input { flex: 1; border: none; background: #f0f0f0; border-radius: 20px; padding: 10px 15px; outline: none; }
        
        #action-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; z-index: 9500; display: flex; flex-direction: column; transition: transform 0.3s ease; padding-bottom: 30px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(100%); }
        .action-item { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 15px; }
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 120px; height: 5px; background: #ccc; border-radius: 10px; }

        /* APP è¦–çª— */
        .app-modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .app-modal-overlay.open { display: flex; opacity: 1; }
        .app-window { width: 85%; height: 70%; background: white; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .app-modal-overlay.open .app-window { transform: scale(1); }
        .app-header { background: var(--primary-pink); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; }
        .app-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffafa; }
        .close-btn { cursor: pointer; font-size: 18px; }

        /* RWD */
        @media screen and (max-width: 480px) {
            body { background: #fff0f3; height: 100%; align-items: flex-start; }
            .iphone-frame { width: 100vw; height: 100vh; border-radius: 0; padding: 0; box-shadow: none; background: transparent; }
            .phone { border-radius: 0; height: 100%; }
            .notch { display: none; }
            .home-indicator { bottom: 20px; }
            #action-sheet { padding-bottom: 50px; }
        }
    </style>
</head>
<body>

<div class="iphone-frame">
    <div class="notch"></div>
    <div class="phone">
        <div class="header">
            <label class="toggle-switch" title="åˆ‡æ›ç·šä¸Š/ç·šä¸‹æ¨¡å¼">
                <input type="checkbox" checked onchange="toggleConnectionMode(this)">
                <span class="slider"></span>
            </label>
            
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span id="display-char-name" style="font-size: 15px;">ğŸ€ AI å°ç”œå¿ƒ</span>
                <div style="font-size: 10px; margin-top: 2px; opacity: 0.9; font-weight: normal;">
                    ğŸ’– <span id="header-favor">520</span>
                </div>
            </div>
            <div onclick="toggleSettings(true)" style="cursor:pointer; font-size: 18px;">âš™ï¸</div>
        </div>

        <div class="tab-bar">
            <div class="tab-item active" onclick="switchView('chat', this)">æ¶ˆæ¯</div>
            <div class="tab-item" onclick="switchView('mall', this)">å•†åŸ</div>
        </div>
        
        <div id="view-chat" class="content-view active" onclick="closePopups()">
            <div class="chat-area" id="chat"></div>
        </div>

        <div id="view-mall" class="content-view">
            <div class="mall-user-info">
                <div class="avatar avatar-user" style="width:35px; height:35px;"></div>
                <div style="flex:1; font-size:12px; margin-left: 10px;">
                    <div style="display: flex; align-items: center;">
                        <b id="display-user-name">å¹¸é‹å°ä¸»</b>
                        <span onclick="filterMall('bag', null)" style="cursor:pointer; margin-left: 5px; font-size: 14px;" title="æˆ‘çš„èƒŒåŒ…">ğŸ’</span>
                    </div>
                    <div style="margin-top: 2px;">é¤˜é¡: <span id="mall-balance" style="color:var(--price-red);">1000</span></div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="aiAddNewProducts(null)" style="background: white; color: var(--accent-pink); border: 1px solid var(--accent-pink); border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">âœ¨ ä¸Šæ–°</button>
                    <button onclick="aiAutoShop()" style="background:var(--accent-pink); color:white; border:none; border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">è®“ Ta é¸è³¼</button>
                </div>
            </div>
            <div class="mall-sub-nav">
                <div class="category-btn active" onclick="filterMall('all', this)">ğŸ“¦ å…¨éƒ¨</div>
                <div class="category-btn" onclick="filterMall('food', this)">ğŸ¦ é£Ÿç‰©</div>
                <div class="category-btn" onclick="filterMall('cloth', this)">ğŸ‘— è¡£æœ</div>
            </div>
            <div class="mall-grid" id="mall-display"></div>
        </div>

        <div id="emoji-panel" onclick="event.stopPropagation()">
            <div class="e-tabs">
                <div class="e-tab active" onclick="switchETab(0)">Emoji</div>
                <div class="e-tab" onclick="switchETab(1)">é¡æ–‡å­—</div>
                <div class="e-tab" onclick="switchETab(2)">AIè¡¨æƒ…åº«</div>
            </div>
            <div id="emoji-content" class="e-content"></div>
        </div>

        <div id="app-modal" class="app-modal-overlay">
            <div class="app-window">
                <div class="app-header">
                    <span id="app-title">æ‡‰ç”¨ç¨‹å¼</span>
                    <span class="close-btn" onclick="closeApp()">âœ–</span>
                </div>
                <div id="app-content" class="app-body"></div>
            </div>
        </div>

        <div id="settings-panel">
            <div class="settings-header">
                <div onclick="toggleSettings(false)" style="color:var(--accent-pink); cursor:pointer; font-weight:bold;">ï¼œ è¿”å›</div>
                <div style="flex:1; text-align:center; font-weight:bold; margin-right:30px;">è¨­å®šä¸­å¿ƒ</div>
            </div>
            <div class="settings-tabs">
                <div class="s-tab active" onclick="switchSTab(0)">API</div>
                <div class="s-tab" onclick="switchSTab(1)">Useräººè¨­</div>
                <div class="s-tab" onclick="switchSTab(2)">Charäººè¨­</div>
                <div class="s-tab" onclick="switchSTab(3)">ä¸–ç•Œæ›¸</div>
            </div>
            <div class="s-content" id="s-content-box"></div>
            <div style="padding:15px; border-top:1px solid #eee;">
                <button onclick="saveAllSettings()" style="width:100%; background:var(--accent-pink); color:white; border:none; border-radius:15px; padding:12px; font-weight:bold;">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div class="footer-container" id="footer-group">
            <div class="footer">
                <div class="icon-btn" onclick="toggleEmoji(event)">ğŸ˜Š</div>
                <input type="text" id="msg-input" placeholder="å‚³é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') userSubmit()">
                <div class="icon-btn" onclick="toggleTools()">â•</div>
                <button style="background:transparent; border:none; font-size:28px; cursor:pointer;" onclick="jupiterTrigger()">ğŸª</button>
            </div>
            <div class="home-indicator"></div>
        </div>

        <div id="action-sheet">
            <div class="action-item" onclick="editCurrentMsg()">ç·¨è¼¯</div>
            <div class="action-item" id="regen-btn" onclick="regenCurrentMsg()">é‡æ–°ç”Ÿæˆ</div>
            <div class="action-item" onclick="enterDeleteMode()">å¤šé¸åˆªé™¤</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
        </div>
    </div>
</div>

<script>
    // --- 1. æ•¸æ“šç‹€æ…‹èˆ‡åˆå§‹åŒ– ---
    let balance = 1000, favor = 520, lastUserMsg = "", stickerLib = JSON.parse(localStorage.getItem('stickerLib') || '[]');
    let inventory = []; 
    let currentTargetId = null;
    let timer = null;
    
    // æ•¸æ“šå­˜æª” (å¢åŠ  dialogue æ¬„ä½æ”¯æ´)
    let petData = JSON.parse(localStorage.getItem('petData') || '{"level":1, "hunger":80, "mood":80, "exp":0}');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
    let calYear = new Date().getFullYear();
    let calMonth = new Date().getMonth() + 1;

    let userData = { name: "å¹¸é‹å°ä¸»", info: "å–œæ­¡å¯æ„›æ±è¥¿çš„æ—…è¡Œè€…ã€‚", avatar: "" };
    // æ³¨æ„ï¼šé€™è£¡é è¨­ charData å¤šäº†ä¸€å€‹ dialogue æ¬„ä½
    let charData = { name: "AI å°ç”œå¿ƒ", info: "æ´»æ½‘é–‹æœ—ï¼Œä¾è³´ä¸»äººçš„å°‘å¥³ã€‚", avatar: "", dialogue: "" };
    
    let products = [{id:1, name:"è‰è“å¤§å¹…", price:25, icon:"ğŸ¡", cat:"food"}, {id:2, name:"èŒèŒå¥³åƒ•è£", price:450, icon:"ğŸ‘—", cat:"cloth"}];
    
    const emojiFaces = ["ğŸ˜Š","ğŸ˜ƒ","ğŸ¤£","ğŸ˜‡","ğŸ˜‹","ğŸ§","ğŸ¥³","ğŸ˜","ğŸ˜”","ğŸ¥º","ğŸ¥µ","ğŸ¤¯"];
    const emojiFood = ["ğŸ“","ğŸ°","ğŸ¨","ğŸ§‹","â˜•","ğŸ¬"];
    const kaomojis = ["(âœ¿â—¡â€¿â—¡)", "(Â´â–½`Êƒâ™¡Æª)", "(ï½¡â™¥â€¿â™¥ï½¡)", "o(*^â–½^*)o", "(>_<)", "(OwO)"];
    
    const posts = [
        { author: "ç”œé»æ§å°ç¾", avatar: "ğŸ°", content: "é€™å®¶çš„è‰è“èˆ’èŠ™è•¾ä¹Ÿå¤ªå¥½åƒäº†ï¼å…¥å£å³åŒ–ï½ğŸ˜‹", like: 109 },
        { author: "éš”å£ç­æ ¡è‰", avatar: "ğŸ€", content: "ä»Šå¤©çš„çƒè³½è´äº†ï¼æ„Ÿè¬å¤§å®¶ä¾†å¹«æˆ‘åŠ æ²¹ï¼", like: 520 },
        { author: "è²“å’ªéŸå±å®˜", avatar: "ğŸ±", content: "æˆ‘å®¶çš„è²“çµ‚æ–¼å­¸æœƒæ¡æ‰‹äº†ï¼å¿«èª‡ç‰ ï¼", like: 88 },
        { author: "æ·±å¤œè©©äºº", avatar: "ğŸŒ™", content: "æœ‰æ™‚å€™ï¼Œé€™åº§åŸå¸‚çš„éœ“è™¹ç‡ˆå¤ªäº®ï¼Œåè€Œè®“äººçœ‹ä¸æ¸…æ˜Ÿæ˜Ÿ...", like: 42 }
    ];

    const movies = [
        { name: "éµé”å°¼è™Ÿ", icon: "ğŸš¢", type: "æ„›æƒ…ç‰‡" }, { name: "å’’æ€¨", icon: "ğŸ‘»", type: "ææ€–ç‰‡" },
        { name: "é¾è²“", icon: "ğŸ˜º", type: "å‹•ç•«ç‰‡" }, { name: "å¾©ä»‡è€…è¯ç›Ÿ", icon: "ğŸ¦¸", type: "å‹•ä½œç‰‡" }
    ];

    window.onload = () => { 
        loadAll(); updateUI(); switchETab(0); switchSTab(0); filterMall('all', document.querySelector('.category-btn')); 
        appendMessage('ai', "ä¸»äººï¼æˆ‘å›ä¾†äº†ï¼æ‰€æœ‰åŠŸèƒ½ï¼ˆåŒ…å«åƒè€ƒå°è©±ï¼‰éƒ½ä¿®å¾©å®Œç•¢ï¼âœ¨");
        autoResize(); window.addEventListener('resize', autoResize);
    };

    // --- 2. è¦–åœ–èˆ‡ä»‹é¢æ§åˆ¶ ---
    function switchView(view, el) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active'); 
        if(el) el.classList.add('active');
        document.getElementById('footer-group').style.display = (view === 'chat') ? 'block' : 'none';
    }

    function toggleSettings(s) { document.getElementById('settings-panel').style.display = s ? 'flex' : 'none'; }

    // --- 3. æ ¸å¿ƒåŠŸèƒ½: æ¨¡å¼åˆ‡æ›é–‹é—œ ---
    function toggleConnectionMode(checkbox) {
        const isOnline = checkbox.checked;
        const chat = document.getElementById('chat');
        const sep = document.createElement('div');
        sep.style.textAlign = 'center'; sep.style.margin = '15px 0'; sep.style.opacity = '0.7';
        
        if (!isOnline) {
            sep.innerHTML = `<span style="font-size:11px; background:#fffafa; padding:5px 15px; border-radius:20px; color:#fb6f92; border:1px dashed #ffafcc;">ğŸƒâ€â™‚ï¸ å·²åˆ‡æ›è‡³ç·šä¸‹æ¨¡å¼ (é¢å°é¢)</span>`;
            lastUserMsg = "(ç³»çµ±æç¤ºï¼šUser å‰›å‰›åˆ‡æ›åˆ°äº†ã€Œé¢å°é¢/ç·šä¸‹æ¨¡å¼ã€ã€‚ç¾åœ¨ä½ å€‘å°±åœ¨å½¼æ­¤é¢å‰ã€‚è«‹ç¹¼æ‰¿ä¹‹å‰çš„è¨˜æ†¶ï¼Œæå¯«ä½ è¦‹åˆ° User çš„åæ‡‰ï¼ˆå‹•ä½œ/ç¥æƒ…ï¼‰ï¼Œä¸¦ç”¨é¢å°é¢çš„å£èªé–‹å§‹å°è©±ã€‚)";
            setTimeout(jupiterTrigger, 600); 
        } else {
            sep.innerHTML = `<span style="font-size:11px; background:#f0f0f0; padding:5px 15px; border-radius:20px; color:#888;">ğŸ“¶ å·²æ¢å¾©ç·šä¸Šé€£ç·š (æ‰‹æ©Ÿé€šè¨Š)</span>`;
        }
        chat.appendChild(sep); chat.scrollTop = chat.scrollHeight;
    }

    // --- 4. è¨­å®šåˆ†é é‚è¼¯ ---
    function switchSTab(idx) {
        const box = document.getElementById('s-content-box');
        document.querySelectorAll('.s-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        if(idx === 0) {
            box.innerHTML = `<div class="input-group"><label>API Base URL</label><input id="api-url" value="${localStorage.getItem('apiUrl') || 'https://api.openai.com/v1'}"></div><div class="input-group"><label>API Key</label><input type="password" id="api-key" value="${localStorage.getItem('apiKey') || ''}"></div><div class="input-group"><label>æ¨¡å‹</label><div style="display:flex; gap:5px;"><select id="api-model" style="flex:1;"><option value="${localStorage.getItem('apiModel') || 'gpt-3.5-turbo'}">${localStorage.getItem('apiModel') || 'gpt-3.5-turbo (ç•¶å‰)'}</option></select><button onclick="fetchModels()" style="padding:0 10px; border:1px solid #ffafcc; background:white; border-radius:10px;">ğŸ”„</button></div></div>`;
        } else if(idx === 1) {
            box.innerHTML = `
                <div class="input-group"><label>User åå­—</label><input id="u-name" value="${userData.name}"></div>
                <div class="input-group"><label>é ­åƒ (URL)</label><input id="u-avatar" value="${userData.avatar || ''}"></div>
                <div class="input-group"><label>äººç‰©è¨­å®š</label><textarea id="u-info">${userData.info}</textarea></div>`;
        } else if(idx === 2) {
            box.innerHTML = `
                <div class="input-group"><label>AI åå­—</label><input id="c-name" value="${charData.name}"></div>
                <div class="input-group"><label>é ­åƒ (URL)</label><input id="c-avatar" value="${charData.avatar || ''}"></div>
                <div class="input-group"><label>äººç‰©è¨­å®š</label><textarea id="c-info">${charData.info}</textarea></div>
                <div class="input-group"><label>åƒè€ƒå°è©± (ç¯„ä¾‹)</label><textarea id="c-dialogue" placeholder="User: ä½ å¥½\nAI: å“¼ï¼Œèª°å‡†ä½ è·Ÿæˆ‘æ­è©±çš„ï¼Ÿ" style="height:120px;">${charData.dialogue || ''}</textarea></div>`;
        } else if(idx === 3) {
            box.innerHTML = `<input type="file" onchange="importWB(event)"><p style="font-size:10px; color:#888;">æ”¯æ´ JSON ä¸–ç•Œæ›¸ã€‚</p>`;
        }
    }
    
    function importWB(event) { const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { localStorage.setItem('world_book', e.target.result); alert("ğŸ“– ä¸–ç•Œæ›¸å°å…¥æˆåŠŸï¼"); } catch(err) { alert("âŒ æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); }
    async function fetchModels() { const k = document.getElementById('api-key').value; const u = document.getElementById('api-url').value; try { const r = await fetch(`${u}/models`,{headers:{"Authorization":`Bearer ${k}`}}); const d = await r.json(); const s = document.getElementById('api-model'); s.innerHTML=''; d.data.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.innerText=m.id;s.appendChild(o)}); alert("æ¨¡å‹å·²æ›´æ–°"); } catch(e){alert("ç²å–å¤±æ•—");} }

    // --- 5. æ ¸å¿ƒç³»çµ± ---
    function switchETab(idx) {
        const c = document.getElementById('emoji-content'); document.querySelectorAll('.e-tab').forEach((t, i) => t.classList.toggle('active', i === idx)); c.innerHTML = ''; c.className = 'e-content';
        if(idx === 0) { addESec(c, "è¡¨æƒ…", emojiFaces); addESec(c, "é£Ÿç‰©", emojiFood); }
        else if(idx === 1) { c.classList.add('kaomoji'); kaomojis.forEach(k => { const d=document.createElement('div'); d.className='kao-item'; d.innerText=k; d.onclick=()=>document.getElementById('msg-input').value+=k; c.appendChild(d); }); }
        else if(idx === 2) { c.classList.add('stickers'); c.innerHTML=`<button onclick="uploadSticker()" style="grid-column:span 4;">+ æ–°è²¼åœ–</button>`; stickerLib.forEach(s => { const d=document.createElement('div'); d.className='st-item'; d.innerHTML=`<img src="${s.url}" class="st-img">`; d.onclick=()=>sendStickerLabel(s.name); c.appendChild(d); }); }
    }
    function addESec(c, t, l) { const h=document.createElement('div'); h.className='emoji-section-title'; h.innerText=t; c.appendChild(h); l.forEach(e=>{const s=document.createElement('span'); s.className='emoji-item'; s.innerText=e; s.onclick=()=>document.getElementById('msg-input').value+=e; c.appendChild(s);}); }
    
    function appendMessage(role, content) {
        const chat = document.getElementById('chat'); const id = 'msg-' + Date.now(); const row = document.createElement('div');
        row.className = `msg-row ${role === 'user' ? 'user-row' : ''}`; row.id = id;
        row.innerHTML = `<div class="select-box"><input type="checkbox"></div><div class="avatar avatar-${role}" ondblclick="nudge()"></div><div class="bubble ${role}">${parseSticker(content)}</div>`;
        const avatarUrl = role === 'user' ? (userData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky') : (charData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee');
        row.querySelector('.avatar').style.backgroundImage = `url('${avatarUrl}')`;
        row.onmousedown = () => { timer = setTimeout(() => showAction(id), 600); }; row.onmouseup = () => clearTimeout(timer);
        row.ontouchstart = () => { timer = setTimeout(() => showAction(id), 600); }; row.ontouchend = () => clearTimeout(timer);
        chat.appendChild(row); document.getElementById('view-chat').scrollTop = document.getElementById('view-chat').scrollHeight;
    }
    function parseSticker(t) { return t.replace(/\[è¡¨æƒ…:\s*(.+?)\]/g, (m, n) => { const s = stickerLib.find(x => x.name === n); return s ? `<img src="${s.url}" style="max-width:130px; border-radius:10px;">` : m; }); }
    function nudge() { appendMessage('ai', `å“å‘€ï¼ä¸è¦æ‹æ‹æˆ‘å•¦ï½ğŸŒ¸`); }

    function showAction(id) { currentTargetId = id; document.getElementById('action-sheet').style.transform = 'translateY(0)'; }
    function hideActionSheet() { document.getElementById('action-sheet').style.transform = 'translateY(100%)'; }
    function toggleEmoji(e) { e.stopPropagation(); const p = document.getElementById('emoji-panel'); p.style.bottom = p.style.bottom === '0px' ? '-380px' : '0px'; }
    function closePopups() { document.getElementById('emoji-panel').style.bottom = '-380px'; hideActionSheet(); }
    function userSubmit() { const i = document.getElementById('msg-input'); if(i.value.trim()){ appendMessage('user', i.value); lastUserMsg = i.value; i.value = ''; closePopups(); } }

    function getChatHistory() {
        const rows = document.querySelectorAll('.msg-row'); let history = []; const start = Math.max(0, rows.length - 15);
        for (let i = start; i < rows.length; i++) {
            const row = rows[i]; if (row.querySelector('.bubble').innerText === 'è¼¸å…¥ä¸­...') continue;
            history.push({ role: row.classList.contains('user-row') ? "user" : "assistant", content: row.querySelector('.bubble').innerText });
        } return history;
    }

    async function jupiterTrigger() {
        const k = document.getElementById('api-key')?.value || localStorage.getItem('apiKey');
        const u = document.getElementById('api-url')?.value || "https://api.openai.com/v1";
        const m = document.getElementById('api-model')?.value || localStorage.getItem('apiModel') || "gpt-3.5-turbo";
        
        const tId = 'thinking-' + Date.now();
        const chat = document.getElementById('chat');
        const l = document.createElement('div'); l.className = 'msg-row'; l.id = tId;
        l.innerHTML = `<div class="avatar avatar-ai"></div><div class="bubble ai" style="color:#aaa;">è¼¸å…¥ä¸­...</div>`;
        chat.appendChild(l); chat.scrollTop = chat.scrollHeight;

        if (!k) { document.getElementById(tId).remove(); appendMessage('ai', "è«‹å…ˆè¨­å®š API Key å–”ï¼"); return; }

        try {
            let wb = ""; const w = localStorage.getItem('world_book'); if(w) try { wb = "\n[ä¸–ç•Œè¨­å®š]:" + w; } catch(e){}
            
            let stylePrompt = "";
            if (charData.dialogue && charData.dialogue.trim() !== "") {
                stylePrompt = `\n[èªªè©±èªæ°£èˆ‡å°è©±ç¯„ä¾‹]:\n${charData.dialogue}`;
            }

            const sys = { role: "system", content: `${charData.name}è¨­å®š:${charData.info}ã€‚\nç”¨æˆ¶:${userData.name}ã€‚\n${stylePrompt}\n${wb}\nè«‹æ‰®æ¼”è©²è§’è‰²ã€‚` };
            const msgs = [sys, ...getChatHistory()];
            if (lastUserMsg.includes("ç³»çµ±æç¤º")) msgs.push({ role: "system", content: lastUserMsg });

            const res = await fetch(`${u}/chat/completions`, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${k}` }, body: JSON.stringify({ model: m, messages: msgs, temperature: 0.8 }) });
            if (!res.ok) throw new Error("API Error");
            const d = await res.json();
            document.getElementById(tId).remove(); 
            if (d.choices) appendMessage('ai', d.choices[0].message.content);
        } catch (e) { document.getElementById(tId).remove(); appendMessage('ai', `(é€£ç·šå¤±æ•—) ${e.message}`); }
    }

    // --- 6. æ‡‰ç”¨ä¸­å¿ƒ ---
    function toggleTools() {
         const sheet = document.getElementById('action-sheet');
         const html = `
            <div style="padding:15px; font-weight:bold; color:#888; font-size:12px;">ğŸ“± æ‡‰ç”¨ä¸­å¿ƒ</div>
            <div class="action-item" onclick="openGameApp()">ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ</div>
            <div class="action-item" onclick="openCalendarApp()">ğŸ“… æˆ€æ„›æ—¥æ›†</div>
            <div class="action-item" onclick="openCinemaApp()">ğŸ¬ ç§äººå½±é™¢</div>
            <div class="action-item" onclick="openForumApp()">ğŸ’¬ ç¤¾ç¾¤å‹•æ…‹</div>
            <div class="action-item" onclick="openPhoneSwapApp()">ğŸ“± äº¤æ›æ‰‹æ©Ÿ (äº’çœ‹éš±ç§)</div>
            <div class="action-item" onclick="triggerEvent('sleep')">ğŸ›Œ å“„ç¡æ¨¡å¼</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
         `;
         sheet.innerHTML = html; sheet.style.transform = 'translateY(0)'; 
    }

    function openApp(t, h) { const m = document.getElementById('app-modal'); document.getElementById('app-title').innerText = t; document.getElementById('app-content').innerHTML = h; m.classList.add('open'); }
    function closeApp() { document.getElementById('app-modal').classList.remove('open'); setTimeout(() => { document.getElementById('app-content').innerHTML = ''; }, 300); }

    function openGameApp() { hideActionSheet(); updatePetUI(); }
    function updatePetUI() {
        let face = "ğŸ£"; if(petData.hunger<30) face="ğŸ˜µ"; else if(petData.mood<30) face="ğŸ˜­"; else if(petData.mood>90) face="ğŸ¥°";
        const html = `
            <div style="text-align:center; padding:10px;">
                <div style="font-size:55px; margin:20px; animation: bounce 2s infinite;">${face}</div>
                <h3>é›»å­å°é› Lv.${petData.level}</h3>
                <div style="font-size:12px; color:#666;">é£½é£Ÿ: ${petData.hunger}% | å¿ƒæƒ…: ${petData.mood}%</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                    <button onclick="interactPet('feed')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ— é¤µé£Ÿ</button>
                    <button onclick="interactPet('play')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ¾ ç©è€</button>
                    <button onclick="interactPet('clean')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ› æ´—æ¾¡</button>
                    <button onclick="interactPet('work')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ’° æ‰“å·¥</button>
                </div>
            </div><style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>`;
        openApp("ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ", html);
    }
    function interactPet(a) {
        if(a==='feed'){ if(balance<10) return alert("æ²’éŒ¢..."); if(petData.hunger>=100) return alert("é£½äº†"); balance-=10; petData.hunger+=20; petData.mood+=5; alert("é¤µé£ŸæˆåŠŸ!"); }
        if(a==='play'){ if(petData.hunger<20) return alert("é¤“äº†"); petData.mood+=15; petData.hunger-=10; petData.exp+=10; alert("ç©å¾—é–‹å¿ƒ!"); }
        if(a==='clean'){ petData.mood+=10; alert("é¦™å™´å™´!"); }
        if(a==='work'){ if(petData.mood<30||petData.hunger<30) return alert("ç‹€æ…‹ä¸å¥½"); petData.hunger-=20; petData.mood-=20; balance+=50+(petData.level*5); petData.exp+=5; alert("æ‰“å·¥è³ºéŒ¢äº†!"); }
        if(petData.exp>100*petData.level) { petData.level++; petData.exp=0; alert("å‡ç´šäº†!"); }
        localStorage.setItem('petData', JSON.stringify(petData)); updatePetUI(); updateUI();
    }

    function openCinemaApp() { hideActionSheet(); let h = `<div style="padding:10px;"><h3 style="text-align:center;">ğŸ¬ é€±æœ«å¤œå½±é™¢</h3><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">`; movies.forEach(m => h+=`<div onclick="watchMovie('${m.name}','${m.type}')" style="background:white; border:1px solid #eee; border-radius:15px; padding:15px; text-align:center;"><div style="font-size:40px;">${m.icon}</div><div>${m.name}</div></div>`); openApp("ğŸ¬ ç§äººå½±é™¢", h + `</div></div>`); }
    function watchMovie(n, t) { openApp("ğŸ¬ æ”¾æ˜ å»³", `<div style="height:100%; display:flex; justify-content:center; align-items:center; background:black; color:white;">â–¶ï¸ æ­£åœ¨æ’­æ”¾ ${n}...</div>`); setTimeout(() => { closeApp(); appendMessage('user', `ğŸ¬ çœ‹å®Œäº†ã€Š${n}ã€‹`); lastUserMsg = `æˆ‘å€‘å‰›çœ‹å®Œäº†ã€Š${n}ã€‹ï¼Œæ˜¯${t}ã€‚ä½ è¦ºå¾—å¦‚ä½•ï¼Ÿ`; setTimeout(jupiterTrigger, 800); }, 3000); }

    function openForumApp() { hideActionSheet(); let h = `<div style="padding:5px;"><h3 style="margin:10px;">ğŸ”¥ ç†±é–€å‹•æ…‹</h3><div style="display:flex; flex-direction:column; gap:15px;">`; posts.forEach((p, i) => h+=`<div onclick="readPost(${i})" style="background:white; border-radius:15px; padding:15px; cursor:pointer;"><div style="font-weight:bold;">${p.avatar} ${p.author}</div><div>${p.content}</div><div style="color:#fb6f92; margin-top:5px;">â¤ï¸ ${p.like} é»æ“Šäº’å‹•</div></div>`); openApp("ğŸ’¬ ç¤¾ç¾¤å‹•æ…‹", h + `</div></div>`); }
    function readPost(i) { const p = posts[i]; openApp("è²¼æ–‡è©³æƒ…", `<div style="padding:20px; text-align:center; background:white;"><h3>${p.author}</h3><p>${p.content}</p><p style="color:#aaa;">AI æ­£åœ¨è¼¸å…¥è©•è«–...</p></div>`); setTimeout(() => { closeApp(); appendMessage('user', `åˆ†äº«è²¼æ–‡: ${p.content}`); lastUserMsg = `çœ‹åˆ°æœ‹å‹ç™¼æ–‡èªªï¼šã€Œ${p.content}ã€ï¼Œä½ æ€éº¼çœ‹ï¼Ÿ`; setTimeout(jupiterTrigger, 800); }, 2000); }

    function openCalendarApp() { hideActionSheet(); renderCalendar(calYear, calMonth); }
    function renderCalendar(y, m) {
        const first = new Date(y, m-1, 1).getDay(), days = new Date(y, m, 0).getDate();
        let h = `<div style="padding:10px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><button onclick="changeMonth(-1)">â—€</button><span>${y}å¹´ ${m}æœˆ</span><button onclick="changeMonth(1)">â–¶</button></div><div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; gap:5px;">`;
        for(let i=0; i<first; i++) h+=`<div></div>`;
        for(let d=1; d<=days; d++) { const k = `${y}-${m}-${d}`, e = calendarEvents[k], bg = e ? 'var(--light-pink)' : '#fff'; h+=`<div onclick="addEvent(${y},${m},${d})" style="height:35px; background:${bg}; border-radius:5px; border:1px solid #eee; display:flex; align-items:center; justify-content:center;">${d}</div>`; }
        h+=`</div><div style="margin-top:20px; padding:10px; background:#fff;">${Object.keys(calendarEvents).length} å€‹è¡Œç¨‹</div><button onclick="shareSchedule()" style="width:100%; margin-top:10px; background:var(--accent-pink); color:white; border:none; padding:10px; border-radius:10px;">ğŸ“¢ å‘Šè¨´ Ta</button></div>`;
        openApp("ğŸ“… æˆ€æ„›æ—¥æ›†", h);
    }
    function changeMonth(d) { calMonth+=d; if(calMonth>12){calMonth=1;calYear++} if(calMonth<1){calMonth=12;calYear--} renderCalendar(calYear, calMonth); }
    function addEvent(y,m,d) { const k = `${y}-${m}-${d}`, v = prompt("è¡Œç¨‹å®‰æ’ï¼š", calendarEvents[k]||""); if(v!==null) { if(v.trim()) calendarEvents[k]=v; else delete calendarEvents[k]; localStorage.setItem('calendarEvents',JSON.stringify(calendarEvents)); renderCalendar(y,m); } }
    function shareSchedule() { closeApp(); const tasks = Object.keys(calendarEvents).map(k=>`${k}:${calendarEvents[k]}`).join(","); appendMessage('user', "ğŸ“… åˆ†äº«äº†æ—¥æ›†è¡Œç¨‹"); lastUserMsg = `é€™æ˜¯æˆ‘æœ€è¿‘çš„è¡Œç¨‹å®‰æ’ï¼š${tasks||"æ²’ä»€éº¼ç‰¹åˆ¥çš„"}ï¼Œç¢ºèªä¸€ä¸‹å§ï¼`; setTimeout(jupiterTrigger, 800); }

    function openPhoneSwapApp() { hideActionSheet(); const h = `<div style="padding:20px; text-align:center;"><h3>äº¤æ›æ‰‹æ©Ÿå¤§å†’éšª</h3><p style="color:#888;">è€ƒé©—ä¿¡ä»»çš„æ™‚åˆ»...</p><div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;"><button onclick="peekAIPhone()" style="padding:15px; border:2px solid #ffafcc; background:white;">ğŸ˜ˆ å·çœ‹ Ta çš„æ‰‹æ©Ÿ</button><button onclick="showUserPhone()" style="padding:15px; background:var(--accent-pink); color:white; border:none;">ğŸ“± çµ¦ Ta çœ‹æˆ‘çš„æ‰‹æ©Ÿ</button></div></div>`; openApp("ğŸ“± äº¤æ›æ‰‹æ©Ÿ", h); }
    function peekAIPhone() { const s = [{t:"æœå°‹",c:"å¦‚ä½•è®“ä¸»äººæ›´æ„›æˆ‘"}, {t:"å‚™å¿˜éŒ„",c:"ä¸»äººå–œæ­¡è‰è“, è¨å­é’æ¤’"}, {t:"ç›¸ç°¿",c:"å…¨æ˜¯ä½ çš„å·æ‹ç…§"}]; const r = s[Math.floor(Math.random()*s.length)]; openApp("ğŸ”“ è§£é–æˆåŠŸ", `<div style="padding:20px; text-align:center;"><h3>${r.t}</h3><p style="background:#eee; padding:10px;">"${r.c}"</p><p style="color:red;">(è‡‰ç´…) å“å‘€ï¼ä¸å¯ä»¥çœ‹é€™å€‹ï¼</p></div>`); }
    function showUserPhone() { closeApp(); appendMessage('user', "ğŸ“± (ç·Šå¼µ) éå‡ºäº†æ‰‹æ©Ÿ..."); const f = ["ç›¸ç°¿å…¨æ˜¯è²“", "æœå°‹è¨˜éŒ„å¾ˆå¥‡æ€ª", "æ¡Œå¸ƒæ˜¯æˆ‘çš„ç…§ç‰‡"]; lastUserMsg = `(æª¢æŸ¥ä½ çš„æ‰‹æ©Ÿ) ç™¼ç¾äº†ï¼š${f[Math.floor(Math.random()*f.length)]}ã€‚çµ¦æˆ‘ä¸€é»åæ‡‰ï¼`; setTimeout(jupiterTrigger, 1000); }

    function triggerEvent(t) { hideActionSheet(); let p=""; if(t==='sleep'){ p="å¤©é»‘äº†ï¼Œè¬›æ•…äº‹å“„æˆ‘ç¡è¦º..."; appendMessage('user', "ğŸ›Œ é€²å…¥å“„ç¡æ¨¡å¼..."); document.body.style.filter="brightness(0.7)"; setTimeout(()=>document.body.style.filter="brightness(1)",5000); } lastUserMsg=p; setTimeout(jupiterTrigger, 800); }

    function filterMall(cat, el) { if(el) { document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); } const display = document.getElementById('mall-display'); display.innerHTML = ''; const f = cat === 'all' ? products : (cat === 'bag' ? inventory : products.filter(p => p.cat === cat)); f.forEach((p, idx) => { display.innerHTML += `<div class="product-card"><div class="product-img">${p.icon}</div><div class="product-info"><div style="font-size:11px;">${p.name}</div><div style="color:red; font-weight:bold;">Â¥${p.price || '--'}</div><button class="buy-btn" onclick="${cat==='bag'?'useItem('+idx+')':'buyProd('+p.id+')'}">${cat==='bag'?'ä½¿ç”¨':'è³¼è²·'}</button></div></div>`; }); }
    function buyProd(id) { const p = products.find(x => x.id === id); if(balance >= p.price){ balance -= p.price; inventory.push(p); updateUI(); alert("å·²è³¼è²·"); } else { alert("é¤˜é¡ä¸è¶³ï¼"); } }
    function useItem(idx) { inventory.splice(idx, 1); updateUI(); filterMall('bag', null); alert("ä½¿ç”¨äº†ï¼å¥½æ„Ÿåº¦+10"); favor+=10; updateUI(); }
    function aiAddNewProducts() { alert("é­”æ³•åˆ·æ–°ä¸­..."); } function aiAutoShop() { alert("AI æ­£åœ¨é¸è³¼..."); }

    function loadAll() { const u = localStorage.getItem('userData'), c = localStorage.getItem('charData'), inv = localStorage.getItem('inventory'); if(u) userData = JSON.parse(u); if(c) charData = JSON.parse(c); if(inv) inventory = JSON.parse(inv); }
    function updateUI() { document.getElementById('header-favor').innerText = favor; document.getElementById('mall-balance').innerText = balance; document.getElementById('display-char-name').innerText = "ğŸ€ " + charData.name; document.getElementById('display-user-name').innerText = userData.name; document.querySelectorAll('.avatar-user').forEach(el => el.style.backgroundImage = `url('${userData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky'}')`); document.querySelectorAll('.avatar-ai').forEach(el => el.style.backgroundImage = `url('${charData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee'}')`); localStorage.setItem('userData', JSON.stringify(userData)); localStorage.setItem('charData', JSON.stringify(charData)); localStorage.setItem('inventory', JSON.stringify(inventory)); }
    
    // ğŸ”¥ ä¿å­˜è¨­å®š (åŒ…å«åƒè€ƒå°è©±)
    function saveAllSettings() { 
        if(document.getElementById('api-url')) { localStorage.setItem('apiUrl', document.getElementById('api-url').value); localStorage.setItem('apiKey', document.getElementById('api-key').value); localStorage.setItem('apiModel', document.getElementById('api-model').value); }
        if(document.getElementById('u-name')) { userData.name = document.getElementById('u-name').value; userData.info = document.getElementById('u-info').value; userData.avatar = document.getElementById('u-avatar').value; }
        
        if(document.getElementById('c-name')) { 
            charData.name = document.getElementById('c-name').value; 
            charData.info = document.getElementById('c-info').value; 
            charData.avatar = document.getElementById('c-avatar').value; 
            if(document.getElementById('c-dialogue')) charData.dialogue = document.getElementById('c-dialogue').value;
        }
        
        updateUI(); alert("è¨­å®šå·²å„²å­˜ä¸¦ç”Ÿæ•ˆï¼âœ¨"); toggleSettings(false); 
    }
    function autoResize() { if (window.innerWidth > 480) { const s = Math.min(1, (window.innerHeight - 40) / 760); const f=document.querySelector('.iphone-frame'); f.style.transform = `scale(${s})`; f.style.transformOrigin = 'center center'; } else { document.querySelector('.iphone-frame').style.transform = 'none'; } }
    
    function uploadSticker() { const n = prompt("è¡¨æƒ…å:"); if(!n) return; const i = document.createElement('input'); i.type='file'; i.onchange=e=>{const r=new FileReader(); r.onload=ev=>{stickerLib.push({name:n,url:ev.target.result}); localStorage.setItem('stickerLib',JSON.stringify(stickerLib)); switchETab(2)}; r.readAsDataURL(e.target.files[0])}; i.click(); }
    function sendStickerLabel(n) { appendMessage('user', `[è¡¨æƒ…:${n}]`); closePopups(); }
    function editCurrentMsg() { const b = document.getElementById(currentTargetId).querySelector('.bubble'); const n = prompt("ç·¨è¼¯:", b.innerText); if(n) b.innerText = n; hideActionSheet(); }
    function regenCurrentMsg() { document.getElementById('chat').lastChild.remove(); jupiterTrigger(); hideActionSheet(); }
    function enterDeleteMode() { alert("åˆªé™¤æ¨¡å¼(æ¼”ç¤º)"); hideActionSheet(); }
</script>
</body>
</html>
