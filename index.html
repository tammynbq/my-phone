<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å¥³é¢¨æ¨¡æ“¬æ‰‹æ©Ÿ - v3.3 æœ€çµ‚ä¿®å¾©ç‰ˆ</title>
    <style>
        :root { --primary-pink: #ffafcc; --light-pink: #ffc2d1; --accent-pink: #fb6f92; --bg-color: #fff0f3; --text-color: #5c5c5c; --price-red: #ff4d4f; }
        body { background: #ffe5ec; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; user-select: none; }
        
        /* æ‰‹æ©Ÿå¤–æ¡† */
        .iphone-frame { width: 375px; height: 760px; background: #333; border-radius: 55px; padding: 12px; box-shadow: 0 50px 100px rgba(0,0,0,0.3); position: relative; }
        .phone { width: 100%; height: 100%; background: #333; border-radius: 43px; position: relative; overflow: hidden; }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 120px; height: 30px; background: black; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; z-index: 10000; }
        
        /* é€šç”¨ç³»çµ±å±¤ */
        .system-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; z-index: 10; }
        .system-screen.hidden { transform: translateY(-100%); pointer-events: none; }
        .system-screen.behind { transform: scale(0.9); opacity: 0; pointer-events: none; }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar { 
            position: absolute; 
            top: 25px; 
            left: 0; 
            width: 100%; 
            padding: 0 45px; 
            box-sizing: border-box; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 12px; 
            font-weight: bold; 
            color: black; 
            z-index: 9000; 
            pointer-events: none; 
            mix-blend-mode: difference; 
            color: white;
        }
        
        /* --- 1. é–å®šç•«é¢ --- */
        #screen-lock { 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); 
            align-items: center; color: white; padding-top: 100px; z-index: 500;
        }
        .lock-date { font-size: 18px; margin-bottom: 10px; opacity: 0.9; }
        .lock-time { font-size: 80px; font-weight: 200; line-height: 1; letter-spacing: -2px; }
        .lock-weather { font-size: 16px; margin-top: 10px; display: flex; align-items: center; gap: 5px; opacity: 0.9; }
        .notification-area { margin-top: 30px; width: 90%; display: flex; flex-direction: column; gap: 10px; }
        .unlock-hint { position: absolute; bottom: 40px; font-size: 12px; opacity: 0.7; animation: bounce 2s infinite; }

        /* --- 2. ä¸»ç•«é¢ (æ¡Œé¢) --- */
        #screen-home { 
            background: #fff0f3; 
            padding-top: 60px; z-index: 400;
        }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px; padding: 20px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .app-icon:active { transform: scale(0.9); }
        .icon-box { width: 55px; height: 55px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 28px; color: white; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .app-name { font-size: 11px; color: #444; font-weight: 500; text-align: center; }
        
        /* --- âœ¨ ä¿®æ”¹é»: Dock åˆ—å†æ¬¡ä¸Šç§» (75px) --- */
        .dock { 
            position: absolute; 
            bottom: 75px; /* å¾ 45px æ”¹ç‚º 75pxï¼Œä¿è­‰ä¸è¢«é®æ“‹ */
            left: 15px; 
            right: 15px; 
            height: 85px; 
            background: rgba(255,255,255,0.6); 
            backdrop-filter: blur(10px); 
            border-radius: 28px; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            padding: 0 10px; 
        }

        /* --- 3. APP å®¹å™¨ --- */
        #screen-app { z-index: 300; display: none; background: white; flex-direction: column; }
        #screen-app.active { display: flex; }

        /* Header */
        .header { 
            background: var(--primary-pink); 
            color: white; 
            padding: 50px 20px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
        }
        .header-btn-left { width: 44px; display: flex; justify-content: flex-start; align-items: center; cursor: pointer; font-size: 20px; }
        .header-btn-right { width: 44px; display: flex; justify-content: flex-end; align-items: center; }

        /* é–‹é—œæ¨£å¼ */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-pink); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* å…§å®¹å€åŸŸ */
        .content-view { flex: 1; overflow-y: auto; display: none; background: var(--bg-color); }
        .content-view.active { display: block; }
        
        .chat-area { padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 100px; }
        .msg-row { display: flex; gap: 8px; align-items: flex-start; transition: 0.3s; position: relative; }
        .msg-row.user-row { flex-direction: row-reverse; }
        .select-box { width: 0; overflow: hidden; display: flex; align-items: center; transition: 0.3s; }
        .delete-mode .select-box { width: 30px; }
        .bubble { max-width: 68%; padding: 12px 14px; border-radius: 20px; font-size: 14px; word-wrap: break-word; cursor: pointer; user-select: none; position: relative; }
        .bubble.ai { background: white; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--primary-pink); color: white; border-bottom-right-radius: 4px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background-size: cover; background-color: var(--light-pink); cursor: pointer; flex-shrink: 0; }

        .footer-container { background: #fff; border-top: 1px solid #eee; padding-bottom: 25px; transition: 0.3s; }
        .footer { padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        input#msg-input { flex: 1; border: none; background: #f0f0f0; border-radius: 20px; padding: 10px 15px; outline: none; }
        
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 120px; height: 5px; background: #ccc; border-radius: 10px; cursor: pointer; z-index: 9999; }
        .home-indicator:hover { background: #999; }

        /* å½ˆçª—èˆ‡è¨­å®š */
        #settings-panel, #emoji-panel, #action-sheet { z-index: 8000; }
        #settings-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; }
        #emoji-panel { position: absolute; bottom: -380px; left: 0; width: 100%; height: 350px; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transition: bottom 0.3s ease; display: flex; flex-direction: column; }
        .e-content { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; align-content: start; }
        .emoji-item { font-size: 26px; text-align: center; cursor: pointer; }
        .e-tabs { display: flex; background: #f9f9f9; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .e-tab { flex: 1; padding: 12px; text-align: center; font-size: 12px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
        .e-tab.active { color: var(--accent-pink); border-bottom-color: var(--accent-pink); font-weight: bold; }
        
        .app-modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .app-modal-overlay.open { display: flex; opacity: 1; }
        .app-window { width: 85%; height: 70%; background: white; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .app-modal-overlay.open .app-window { transform: scale(1); }
        .app-header { background: var(--primary-pink); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; }
        .app-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffafa; }

        #action-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; display: flex; flex-direction: column; transition: transform 0.3s ease; padding-bottom: 30px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(100%); }
        .action-item { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 15px; }

        .settings-header { display: flex; align-items: center; padding: 45px 15px 15px; border-bottom: 1px solid #eee; }
        .settings-tabs { display: flex; background: #f9f9f9; }
        .s-tab { flex: 1; padding: 10px; text-align: center; font-size: 11px; cursor: pointer; border-bottom: 1px solid #ddd; }
        .s-tab.active { border-bottom: 2px solid var(--accent-pink); color: var(--accent-pink); font-weight: bold; }
        .s-content { padding: 15px; flex: 1; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ffdae0; border-radius: 12px; box-sizing: border-box; outline: none; }
        textarea { width: 100%; height: 100px; border: 1px solid #ffdae0; border-radius: 12px; padding: 10px; font-size: 12px; resize: none; box-sizing: border-box; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

<div class="iphone-frame">
    <div class="status-bar">
        <span id="status-time">12:00</span>
        <span style="flex:1;"></span>
        <span style="font-size:12px;">5G ğŸ”‹ 100%</span>
    </div>

    <div class="notch"></div>

    <div class="phone">
        <div id="screen-lock" class="system-screen" onclick="unlockPhone()">
            <div style="font-size:24px;">ğŸ”“</div>
            <div class="lock-date" id="lock-date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            <div class="lock-time" id="lock-time">12:00</div>
            <div class="lock-weather">ğŸŒ¤ï¸ æ™´ 24Â°C</div>
            <div class="notification-area" id="lock-notifications"></div>
            <div class="unlock-hint">å‘ä¸Šæ»‘å‹•è§£é–</div>
        </div>

        <div id="screen-home" class="system-screen hidden">
            <div class="app-grid">
                <div class="app-icon" onclick="openSystemApp('chat')">
                    <div class="icon-box" style="background:#ff9a9e;">ğŸ’¬</div>
                    <div class="app-name">Q (ï½¡â€¢á´—â€¢ï½¡)</div>
                </div>
                <div class="app-icon" onclick="alert('ğŸ›ï¸ å•†åŸç³»çµ±å‡ç´šç¶­è­·ä¸­...\nè«‹ç¨å¾Œå†å›ä¾†ï¼')">
                    <div class="icon-box" style="background:#ffbd59; opacity:0.6;">ğŸ›ï¸</div>
                    <div class="app-name">è³¼ç‰© (ç¶­è­·)</div>
                </div>
                <div class="app-icon" onclick="openGameApp()">
                    <div class="icon-box" style="background:#a0e7e5;">ğŸ®</div>
                    <div class="app-name">å¯µç‰©æ©Ÿ</div>
                </div>
                <div class="app-icon" onclick="openCalendarApp()">
                    <div class="icon-box" style="background:#b9fbc0;">ğŸ“…</div>
                    <div class="app-name">æ—¥æ›†</div>
                </div>
                <div class="app-icon" onclick="openCinemaApp()">
                    <div class="icon-box" style="background:#ff9248;">ğŸ¬</div>
                    <div class="app-name">å½±é™¢</div>
                </div>
                <div class="app-icon" onclick="openForumApp()">
                    <div class="icon-box" style="background:#74b9ff;">ğŸŒ</div>
                    <div class="app-name">ç¤¾ç¾¤</div>
                </div>
                <div class="app-icon" onclick="openPhoneSwapApp()">
                    <div class="icon-box" style="background:#fd79a8;">ğŸ˜ˆ</div>
                    <div class="app-name">å¤§å†’éšª</div>
                </div>
                <div class="app-icon" onclick="toggleSettings(true)">
                    <div class="icon-box" style="background:#dfe6e9; color:#636e72;">âš™ï¸</div>
                    <div class="app-name">è¨­å®š</div>
                </div>
            </div>

            <div class="dock">
                <div class="app-icon" onclick="alert('é€šè©±åŠŸèƒ½é–‹ç™¼ä¸­...')">
                    <div class="icon-box" style="background:#55efc4; width:45px; height:45px; font-size:24px;">ğŸ“</div>
                </div>
                <div class="app-icon" onclick="openSystemApp('chat')">
                    <div class="icon-box" style="background:#fff; width:45px; height:45px; font-size:24px; border:1px solid #eee;">ğŸ’¬</div>
                </div>
                <div class="app-icon" onclick="alert('ç›¸æ©ŸåŠŸèƒ½é–‹ç™¼ä¸­...')">
                    <div class="icon-box" style="background:#fab1a0; width:45px; height:45px; font-size:24px;">ğŸ“·</div>
                </div>
            </div>
        </div>

        <div id="screen-app" class="system-screen hidden">
            <div class="header">
                <div class="header-btn-left" onclick="goHome()">â¬…ï¸</div>
                
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <span id="display-char-name" style="font-size: 15px;">ğŸ€ AI å°ç”œå¿ƒ</span>
                    <div style="font-size: 10px; margin-top: 2px; opacity: 0.9; font-weight: normal;">
                        ğŸ’– <span id="header-favor">520</span>
                    </div>
                </div>
                
                <div class="header-btn-right">
                    <label class="toggle-switch" title="åˆ‡æ›ç·šä¸Š/ç·šä¸‹æ¨¡å¼">
                        <input type="checkbox" checked onchange="toggleConnectionMode(this)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="tab-bar">
                <div class="tab-item active">æ¶ˆæ¯</div>
            </div>
            
            <div id="view-chat" class="content-view active" onclick="closePopups()">
                <div class="chat-area" id="chat"></div>
            </div>

            <div id="view-mall" class="content-view" style="display: none !important;">
                <div class="mall-user-info"><div class="avatar avatar-user" style="width:35px; height:35px;"></div><div style="flex:1; font-size:12px; margin-left: 10px;"><div style="display: flex; align-items: center;"><b id="display-user-name">å¹¸é‹å°ä¸»</b><span onclick="filterMall('bag', null)" style="cursor:pointer; margin-left: 5px; font-size: 14px;" title="æˆ‘çš„èƒŒåŒ…">ğŸ’</span></div><div style="margin-top: 2px;">é¤˜é¡: <span id="mall-balance" style="color:var(--price-red);">1000</span></div></div><div style="display: flex; gap: 5px;"><button onclick="aiAddNewProducts()" style="background: white; color: var(--accent-pink); border: 1px solid var(--accent-pink); border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">âœ¨ ä¸Šæ–°</button><button onclick="aiAutoShop()" style="background:var(--accent-pink); color:white; border:none; border-radius:12px; padding:5px 10px; font-size:11px; cursor: pointer;">è®“ Ta é¸è³¼</button></div></div><div class="mall-sub-nav"><div class="category-btn active" onclick="filterMall('all', this)">ğŸ“¦ å…¨éƒ¨</div><div class="category-btn" onclick="filterMall('food', this)">ğŸ¦ é£Ÿç‰©</div><div class="category-btn" onclick="filterMall('cloth', this)">ğŸ‘— è¡£æœ</div><div class="category-btn" onclick="filterMall('3c', this)">ğŸ“± é›»å™¨</div><div class="category-btn" onclick="filterMall('decor', this)">ğŸ›‹ï¸ å±…å®¶</div></div><div class="mall-grid" id="mall-display"></div>
            </div>

            <div class="footer-container" id="footer-group">
                <div class="footer">
                    <div class="icon-btn" onclick="toggleEmoji(event)">ğŸ˜Š</div>
                    <input type="text" id="msg-input" placeholder="å‚³é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') userSubmit()">
                    <div class="icon-btn" onclick="toggleTools()">â•</div>
                    <button style="background:transparent; border:none; font-size:28px; cursor:pointer;" onclick="jupiterTrigger()">ğŸª</button>
                </div>
            </div>
        </div>

        <div id="emoji-panel" onclick="event.stopPropagation()">
            <div class="e-tabs">
                <div class="e-tab active" onclick="switchETab(0)">Emoji</div>
                <div class="e-tab" onclick="switchETab(1)">é¡æ–‡å­—</div>
                <div class="e-tab" onclick="switchETab(2)">AIè¡¨æƒ…åº«</div>
            </div>
            <div id="emoji-content" class="e-content"></div>
        </div>

        <div id="app-modal" class="app-modal-overlay">
            <div class="app-window">
                <div class="app-header">
                    <span id="app-title">æ‡‰ç”¨ç¨‹å¼</span>
                    <span class="close-btn" onclick="closeApp()">âœ–</span>
                </div>
                <div id="app-content" class="app-body"></div>
            </div>
        </div>

        <div id="settings-panel">
            <div class="settings-header">
                <div onclick="toggleSettings(false)" style="color:var(--accent-pink); cursor:pointer; font-weight:bold;">ï¼œ è¿”å›</div>
                <div style="flex:1; text-align:center; font-weight:bold; margin-right:30px;">è¨­å®šä¸­å¿ƒ</div>
            </div>
            <div class="settings-tabs">
                <div class="s-tab active" onclick="switchSTab(0)">API</div>
                <div class="s-tab" onclick="switchSTab(1)">Useräººè¨­</div>
                <div class="s-tab" onclick="switchSTab(2)">Charäººè¨­</div>
                <div class="s-tab" onclick="switchSTab(3)">ä¸–ç•Œæ›¸</div>
            </div>
            <div class="s-content" id="s-content-box"></div>
            <div style="padding:15px; border-top:1px solid #eee;">
                <button onclick="saveAllSettings()" style="width:100%; background:var(--accent-pink); color:white; border:none; border-radius:15px; padding:12px; font-weight:bold;">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div id="action-sheet">
            <div class="action-item" onclick="editCurrentMsg()">ç·¨è¼¯</div>
            <div class="action-item" id="regen-btn" onclick="regenCurrentMsg()">é‡æ–°ç”Ÿæˆ</div>
            <div class="action-item" onclick="enterDeleteMode()">å¤šé¸åˆªé™¤</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
        </div>

        <div class="home-indicator" onclick="goHome()"></div>
    </div>
</div>

<script>
    // --- 0. ç³»çµ±å±¤é‚è¼¯ ---
    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        document.getElementById('status-time').innerText = timeStr;
        document.getElementById('lock-time').innerText = timeStr;
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        document.getElementById('lock-date').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${days[now.getDay()]}`;
    }
    setInterval(updateClock, 1000);

    function unlockPhone() {
        document.getElementById('screen-lock').classList.add('hidden');
        document.getElementById('screen-home').classList.remove('hidden');
    }

    function goHome() {
        document.getElementById('screen-app').classList.remove('active');
        document.getElementById('screen-app').classList.add('hidden');
        document.getElementById('screen-home').classList.remove('hidden');
        document.getElementById('screen-home').classList.remove('behind');
        closeApp();
    }

    function openSystemApp(appName) {
        const home = document.getElementById('screen-home');
        const appScreen = document.getElementById('screen-app');
        home.classList.add('behind');
        setTimeout(() => home.classList.add('hidden'), 300);
        
        if (appName === 'chat') {
            appScreen.classList.remove('hidden');
            appScreen.classList.add('active');
        }
    }

    // --- 1. æ•¸æ“šç‹€æ…‹èˆ‡åˆå§‹åŒ– ---
    let balance = 1000, favor = 520, lastUserMsg = "", stickerLib = JSON.parse(localStorage.getItem('stickerLib') || '[]');
    let inventory = []; 
    let currentTargetId = null;
    let timer = null;
    let currentCat = 'all'; 
    
    let petData = JSON.parse(localStorage.getItem('petData') || '{"level":1, "hunger":80, "mood":80, "exp":0}');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
    let calYear = new Date().getFullYear();
    let calMonth = new Date().getMonth() + 1;

    let userData = { name: "å¹¸é‹å°ä¸»", info: "å–œæ­¡å¯æ„›æ±è¥¿çš„æ—…è¡Œè€…ã€‚", avatar: "" };
    let charData = { name: "AI å°ç”œå¿ƒ", info: "æ´»æ½‘é–‹æœ—ï¼Œä¾è³´ä¸»äººçš„å°‘å¥³ã€‚", avatar: "", dialogue: "" };
    
    let defaultProducts = [
        {id:1, name:"è‰è“å¤§å¹…", price:25, icon:"ğŸ¡", cat:"food", stock:10}, 
        {id:2, name:"èŒèŒå¥³åƒ•è£", price:450, icon:"ğŸ‘—", cat:"cloth", stock:1},
        {id:3, name:"æ‹ç«‹å¾—ç›¸æ©Ÿ", price:800, icon:"ğŸ“·", cat:"3c", stock:3},
        {id:4, name:"æ‡¶äººæ²™ç™¼", price:350, icon:"ğŸ›‹ï¸", cat:"decor", stock:5},
        {id:5, name:"éŠæˆ²æ‰‹æŠŠ", price:500, icon:"ğŸ®", cat:"3c", stock:5},
        {id:6, name:"çç å¥¶èŒ¶", price:60, icon:"ğŸ§‹", cat:"food", stock:20}
    ];
    let products = JSON.parse(localStorage.getItem('shopProducts'));
    if (!products || products.length === 0) products = defaultProducts;
    
    const emojiFaces = ["ğŸ˜Š","ğŸ˜ƒ","ğŸ¤£","ğŸ˜‡","ğŸ˜‹","ğŸ§","ğŸ¥³","ğŸ˜","ğŸ˜”","ğŸ¥º","ğŸ¥µ","ğŸ¤¯"];
    const emojiFood = ["ğŸ“","ğŸ°","ğŸ¨","ğŸ§‹","â˜•","ğŸ¬"];
    const kaomojis = ["(âœ¿â—¡â€¿â—¡)", "(Â´â–½`Êƒâ™¡Æª)", "(ï½¡â™¥â€¿â™¥ï½¡)", "o(*^â–½^*)o", "(>_<)", "(OwO)"];
    
    const posts = [
        { author: "ç”œé»æ§å°ç¾", avatar: "ğŸ°", content: "é€™å®¶çš„è‰è“èˆ’èŠ™è•¾ä¹Ÿå¤ªå¥½åƒäº†ï¼å…¥å£å³åŒ–ï½ğŸ˜‹", like: 109 },
        { author: "éš”å£ç­æ ¡è‰", avatar: "ğŸ€", content: "ä»Šå¤©çš„çƒè³½è´äº†ï¼æ„Ÿè¬å¤§å®¶ä¾†å¹«æˆ‘åŠ æ²¹ï¼", like: 520 },
        { author: "è²“å’ªéŸå±å®˜", avatar: "ğŸ±", content: "æˆ‘å®¶çš„è²“çµ‚æ–¼å­¸æœƒæ¡æ‰‹äº†ï¼å¿«èª‡ç‰ ï¼", like: 88 },
        { author: "æ·±å¤œè©©äºº", avatar: "ğŸŒ™", content: "æœ‰æ™‚å€™ï¼Œé€™åº§åŸå¸‚çš„éœ“è™¹ç‡ˆå¤ªäº®ï¼Œåè€Œè®“äººçœ‹ä¸æ¸…æ˜Ÿæ˜Ÿ...", like: 42 }
    ];

    const movies = [
        { name: "éµé”å°¼è™Ÿ", icon: "ğŸš¢", type: "æ„›æƒ…ç‰‡" }, { name: "å’’æ€¨", icon: "ğŸ‘»", type: "ææ€–ç‰‡" },
        { name: "é¾è²“", icon: "ğŸ˜º", type: "å‹•ç•«ç‰‡" }, { name: "å¾©ä»‡è€…è¯ç›Ÿ", icon: "ğŸ¦¸", type: "å‹•ä½œç‰‡" }
    ];

    window.onload = () => { 
        loadAll(); updateUI(); switchETab(0); switchSTab(0); 
        filterMall('all', document.querySelectorAll('.category-btn')[0]); 
        updateClock(); 
        autoResize(); window.addEventListener('resize', autoResize);
    };

    function toggleSettings(s) { document.getElementById('settings-panel').style.display = s ? 'flex' : 'none'; }

    // --- 3. æ ¸å¿ƒåŠŸèƒ½: æ¨¡å¼åˆ‡æ›é–‹é—œ ---
    function toggleConnectionMode(checkbox) {
        const isOnline = checkbox.checked;
        const chat = document.getElementById('chat');
        const sep = document.createElement('div');
        sep.style.textAlign = 'center'; sep.style.margin = '15px 0'; sep.style.opacity = '0.7';
        
        if (!isOnline) {
            sep.innerHTML = `<span style="font-size:11px; background:#fffafa; padding:5px 15px; border-radius:20px; color:#fb6f92; border:1px dashed #ffafcc;">ğŸƒâ€â™‚ï¸ å·²åˆ‡æ›è‡³ç·šä¸‹æ¨¡å¼ (é¢å°é¢)</span>`;
            lastUserMsg = "(ç³»çµ±æç¤ºï¼šUser å‰›å‰›åˆ‡æ›åˆ°äº†ã€Œé¢å°é¢/ç·šä¸‹æ¨¡å¼ã€ã€‚ç¾åœ¨ä½ å€‘å°±åœ¨å½¼æ­¤é¢å‰ã€‚è«‹ç¹¼æ‰¿ä¹‹å‰çš„è¨˜æ†¶ï¼Œæå¯«ä½ è¦‹åˆ° User çš„åæ‡‰ï¼ˆå‹•ä½œ/ç¥æƒ…ï¼‰ï¼Œä¸¦ç”¨é¢å°é¢çš„å£èªé–‹å§‹å°è©±ã€‚)";
            setTimeout(jupiterTrigger, 600); 
        } else {
            sep.innerHTML = `<span style="font-size:11px; background:#f0f0f0; padding:5px 15px; border-radius:20px; color:#888;">ğŸ“¶ å·²æ¢å¾©ç·šä¸Šé€£ç·š (æ‰‹æ©Ÿé€šè¨Š)</span>`;
        }
        chat.appendChild(sep); chat.scrollTop = chat.scrollHeight;
    }

    // --- 4. è¨­å®šåˆ†é é‚è¼¯ ---
    function switchSTab(idx) {
        const box = document.getElementById('s-content-box');
        document.querySelectorAll('.s-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        if(idx === 0) {
            box.innerHTML = `<div class="input-group"><label>API Base URL</label><input id="api-url" value="${localStorage.getItem('apiUrl') || 'https://api.openai.com/v1'}"></div><div class="input-group"><label>API Key</label><input type="password" id="api-key" value="${localStorage.getItem('apiKey') || ''}"></div><div class="input-group"><label>æ¨¡å‹</label><div style="display:flex; gap:5px;"><select id="api-model" style="flex:1;"><option value="${localStorage.getItem('apiModel') || 'gpt-3.5-turbo'}">${localStorage.getItem('apiModel') || 'gpt-3.5-turbo (ç•¶å‰)'}</option></select><button onclick="fetchModels()" style="padding:0 10px; border:1px solid #ffafcc; background:white; border-radius:10px;">ğŸ”„</button></div></div>`;
        } else if(idx === 1) {
            box.innerHTML = `
                <div class="input-group"><label>User åå­—</label><input id="u-name" value="${userData.name}"></div>
                <div class="input-group"><label>é ­åƒ (URL)</label><input id="u-avatar" value="${userData.avatar || ''}"></div>
                <div class="input-group"><label>äººç‰©è¨­å®š</label><textarea id="u-info">${userData.info}</textarea></div>`;
        } else if(idx === 2) {
            box.innerHTML = `
                <div class="input-group"><label>AI åå­—</label><input id="c-name" value="${charData.name}"></div>
                <div class="input-group"><label>é ­åƒ (URL)</label><input id="c-avatar" value="${charData.avatar || ''}"></div>
                <div class="input-group"><label>äººç‰©è¨­å®š</label><textarea id="c-info">${charData.info}</textarea></div>
                <div class="input-group"><label>åƒè€ƒå°è©± (ç¯„ä¾‹)</label><textarea id="c-dialogue" placeholder="User: ä½ å¥½\nAI: å“¼ï¼Œèª°å‡†ä½ è·Ÿæˆ‘æ­è©±çš„ï¼Ÿ" style="height:120px;">${charData.dialogue || ''}</textarea></div>`;
        } else if(idx === 3) {
            box.innerHTML = `<input type="file" onchange="importWB(event)"><p style="font-size:10px; color:#888;">æ”¯æ´ JSON ä¸–ç•Œæ›¸ã€‚</p>`;
        }
    }
    
    function importWB(event) { const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { localStorage.setItem('world_book', e.target.result); alert("ğŸ“– ä¸–ç•Œæ›¸å°å…¥æˆåŠŸï¼"); } catch(err) { alert("âŒ æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); }
    async function fetchModels() { const k = document.getElementById('api-key').value; const u = document.getElementById('api-url').value; try { const r = await fetch(`${u}/models`,{headers:{"Authorization":`Bearer ${k}`}}); const d = await r.json(); const s = document.getElementById('api-model'); s.innerHTML=''; d.data.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.innerText=m.id;s.appendChild(o)}); alert("æ¨¡å‹å·²æ›´æ–°"); } catch(e){alert("ç²å–å¤±æ•—");} }

    // --- 5. æ ¸å¿ƒç³»çµ± ---
    function switchETab(idx) {
        const c = document.getElementById('emoji-content'); document.querySelectorAll('.e-tab').forEach((t, i) => t.classList.toggle('active', i === idx)); c.innerHTML = ''; c.className = 'e-content';
        if(idx === 0) { addESec(c, "è¡¨æƒ…", emojiFaces); addESec(c, "é£Ÿç‰©", emojiFood); }
        else if(idx === 1) { c.classList.add('kaomoji'); kaomojis.forEach(k => { const d=document.createElement('div'); d.className='kao-item'; d.innerText=k; d.onclick=()=>document.getElementById('msg-input').value+=k; c.appendChild(d); }); }
        else if(idx === 2) { c.classList.add('stickers'); c.innerHTML=`<button onclick="uploadSticker()" style="grid-column:span 4;">+ æ–°è²¼åœ–</button>`; stickerLib.forEach(s => { const d=document.createElement('div'); d.className='st-item'; d.innerHTML=`<img src="${s.url}" class="st-img">`; d.onclick=()=>sendStickerLabel(s.name); c.appendChild(d); }); }
    }
    function addESec(c, t, l) { const h=document.createElement('div'); h.className='emoji-section-title'; h.innerText=t; c.appendChild(h); l.forEach(e=>{const s=document.createElement('span'); s.className='emoji-item'; s.innerText=e; s.onclick=()=>document.getElementById('msg-input').value+=e; c.appendChild(s);}); }
    
    function appendMessage(role, content) {
        const chat = document.getElementById('chat'); const id = 'msg-' + Date.now(); const row = document.createElement('div');
        row.className = `msg-row ${role === 'user' ? 'user-row' : ''}`; row.id = id;
        row.innerHTML = `<div class="select-box"><input type="checkbox"></div><div class="avatar avatar-${role}" ondblclick="nudge()"></div><div class="bubble ${role}">${parseSticker(content)}</div>`;
        const avatarUrl = role === 'user' ? (userData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky') : (charData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee');
        row.querySelector('.avatar').style.backgroundImage = `url('${avatarUrl}')`;
        row.onmousedown = () => { timer = setTimeout(() => showAction(id), 600); }; row.onmouseup = () => clearTimeout(timer);
        row.ontouchstart = () => { timer = setTimeout(() => showAction(id), 600); }; row.ontouchend = () => clearTimeout(timer);
        chat.appendChild(row); document.getElementById('view-chat').scrollTop = document.getElementById('view-chat').scrollHeight;
    }
    function parseSticker(t) { return t.replace(/\[è¡¨æƒ…:\s*(.+?)\]/g, (m, n) => { const s = stickerLib.find(x => x.name === n); return s ? `<img src="${s.url}" style="max-width:130px; border-radius:10px;">` : m; }); }
    function nudge() { appendMessage('ai', `å“å‘€ï¼ä¸è¦æ‹æ‹æˆ‘å•¦ï½ğŸŒ¸`); }

    function showAction(id) { currentTargetId = id; document.getElementById('action-sheet').style.transform = 'translateY(0)'; }
    function hideActionSheet() { document.getElementById('action-sheet').style.transform = 'translateY(100%)'; }
    function toggleEmoji(e) { e.stopPropagation(); const p = document.getElementById('emoji-panel'); p.style.bottom = p.style.bottom === '0px' ? '-380px' : '0px'; }
    function closePopups() { document.getElementById('emoji-panel').style.bottom = '-380px'; hideActionSheet(); }
    function userSubmit() { const i = document.getElementById('msg-input'); if(i.value.trim()){ appendMessage('user', i.value); lastUserMsg = i.value; i.value = ''; closePopups(); } }

    function getChatHistory() {
        const rows = document.querySelectorAll('.msg-row'); let history = []; const start = Math.max(0, rows.length - 15);
        for (let i = start; i < rows.length; i++) {
            const row = rows[i]; if (row.querySelector('.bubble').innerText === 'è¼¸å…¥ä¸­...') continue;
            history.push({ role: row.classList.contains('user-row') ? "user" : "assistant", content: row.querySelector('.bubble').innerText });
        } return history;
    }

    async function jupiterTrigger() {
        const k = document.getElementById('api-key')?.value || localStorage.getItem('apiKey');
        const u = document.getElementById('api-url')?.value || "https://api.openai.com/v1";
        const m = document.getElementById('api-model')?.value || localStorage.getItem('apiModel') || "gpt-3.5-turbo";
        
        const tId = 'thinking-' + Date.now();
        const chat = document.getElementById('chat');
        const l = document.createElement('div'); l.className = 'msg-row'; l.id = tId;
        l.innerHTML = `<div class="avatar avatar-ai"></div><div class="bubble ai" style="color:#aaa;">è¼¸å…¥ä¸­...</div>`;
        chat.appendChild(l); chat.scrollTop = chat.scrollHeight;

        if (!k) { document.getElementById(tId).remove(); appendMessage('ai', "è«‹å…ˆè¨­å®š API Key å–”ï¼"); return; }

        try {
            let wb = ""; const w = localStorage.getItem('world_book'); if(w) try { wb = "\n[ä¸–ç•Œè¨­å®š]:" + w; } catch(e){}
            let stylePrompt = "";
            if (charData.dialogue && charData.dialogue.trim() !== "") {
                stylePrompt = `\n[èªªè©±èªæ°£èˆ‡å°è©±ç¯„ä¾‹]:\n${charData.dialogue}`;
            }

            const sys = { role: "system", content: `${charData.name}è¨­å®š:${charData.info}ã€‚\nç”¨æˆ¶:${userData.name}ã€‚\n${stylePrompt}\n${wb}\nè«‹æ‰®æ¼”è©²è§’è‰²ã€‚` };
            const msgs = [sys, ...getChatHistory()];
            if (lastUserMsg.includes("ç³»çµ±æç¤º")) msgs.push({ role: "system", content: lastUserMsg });

            const res = await fetch(`${u}/chat/completions`, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${k}` }, body: JSON.stringify({ model: m, messages: msgs, temperature: 0.8 }) });
            if (!res.ok) throw new Error("API Error");
            const d = await res.json();
            document.getElementById(tId).remove(); 
            if (d.choices) appendMessage('ai', d.choices[0].message.content);
        } catch (e) { document.getElementById(tId).remove(); appendMessage('ai', `(é€£ç·šå¤±æ•—) ${e.message}`); }
    }

    // --- 6. æ‡‰ç”¨ä¸­å¿ƒ ---
    function toggleTools() {
         const sheet = document.getElementById('action-sheet');
         const html = `
            <div style="padding:15px; font-weight:bold; color:#888; font-size:12px;">ğŸ“± æ·å¾‘ä¸­å¿ƒ</div>
            <div class="action-item" onclick="openGameApp()">ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ</div>
            <div class="action-item" onclick="openCalendarApp()">ğŸ“… æˆ€æ„›æ—¥æ›†</div>
            <div class="action-item" onclick="openCinemaApp()">ğŸ¬ ç§äººå½±é™¢</div>
            <div class="action-item" onclick="openForumApp()">ğŸ’¬ ç¤¾ç¾¤å‹•æ…‹</div>
            <div class="action-item" onclick="openPhoneSwapApp()">ğŸ˜ˆ äº¤æ›æ‰‹æ©Ÿ</div>
            <div class="action-item" onclick="triggerEvent('sleep')">ğŸ›Œ å“„ç¡æ¨¡å¼</div>
            <div class="action-item" onclick="hideActionSheet()" style="color:#aaa">å–æ¶ˆ</div>
         `;
         sheet.innerHTML = html; sheet.style.transform = 'translateY(0)'; 
    }

    function openApp(t, h) { const m = document.getElementById('app-modal'); document.getElementById('app-title').innerText = t; document.getElementById('app-content').innerHTML = h; m.classList.add('open'); }
    function closeApp() { document.getElementById('app-modal').classList.remove('open'); setTimeout(() => { document.getElementById('app-content').innerHTML = ''; }, 300); }

    function openGameApp() { hideActionSheet(); updatePetUI(); }
    function updatePetUI() {
        let face = "ğŸ£"; if(petData.hunger<30) face="ğŸ˜µ"; else if(petData.mood<30) face="ğŸ˜­"; else if(petData.mood>90) face="ğŸ¥°";
        const html = `
            <div style="text-align:center; padding:10px;">
                <div style="font-size:55px; margin:20px; animation: bounce 2s infinite;">${face}</div>
                <h3>é›»å­å°é› Lv.${petData.level}</h3>
                <div style="font-size:12px; color:#666;">é£½é£Ÿ: ${petData.hunger}% | å¿ƒæƒ…: ${petData.mood}%</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                    <button onclick="interactPet('feed')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ— é¤µé£Ÿ</button>
                    <button onclick="interactPet('play')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ¾ ç©è€</button>
                    <button onclick="interactPet('clean')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ› æ´—æ¾¡</button>
                    <button onclick="interactPet('work')" style="padding:15px; border:1px solid #eee; background:white;">ğŸ’° æ‰“å·¥</button>
                </div>
            </div><style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>`;
        openApp("ğŸ® å¯µç‰©éŠæˆ²æ©Ÿ", html);
    }
    function interactPet(a) {
        if(a==='feed'){ if(balance<10) return alert("æ²’éŒ¢..."); if(petData.hunger>=100) return alert("é£½äº†"); balance-=10; petData.hunger+=20; petData.mood+=5; alert("é¤µé£ŸæˆåŠŸ!"); }
        if(a==='play'){ if(petData.hunger<20) return alert("é¤“äº†"); petData.mood+=15; petData.hunger-=10; petData.exp+=10; alert("ç©å¾—é–‹å¿ƒ!"); }
        if(a==='clean'){ petData.mood+=10; alert("é¦™å™´å™´!"); }
        if(a==='work'){ if(petData.mood<30||petData.hunger<30) return alert("ç‹€æ…‹ä¸å¥½"); petData.hunger-=20; petData.mood-=20; balance+=50+(petData.level*5); petData.exp+=5; alert("æ‰“å·¥è³ºéŒ¢äº†!"); }
        if(petData.exp>100*petData.level) { petData.level++; petData.exp=0; alert("å‡ç´šäº†!"); }
        localStorage.setItem('petData', JSON.stringify(petData)); updatePetUI(); updateUI();
    }

    function openCinemaApp() { hideActionSheet(); let h = `<div style="padding:10px;"><h3 style="text-align:center;">ğŸ¬ é€±æœ«å¤œå½±é™¢</h3><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">`; movies.forEach(m => h+=`<div onclick="watchMovie('${m.name}','${m.type}')" style="background:white; border:1px solid #eee; border-radius:15px; padding:15px; text-align:center;"><div style="font-size:40px;">${m.icon}</div><div>${m.name}</div></div>`); openApp("ğŸ¬ ç§äººå½±é™¢", h + `</div></div>`); }
    function watchMovie(n, t) { openApp("ğŸ¬ æ”¾æ˜ å»³", `<div style="height:100%; display:flex; justify-content:center; align-items:center; background:black; color:white;">â–¶ï¸ æ­£åœ¨æ’­æ”¾ ${n}...</div>`); setTimeout(() => { closeApp(); appendMessage('user', `ğŸ¬ çœ‹å®Œäº†ã€Š${n}ã€‹`); lastUserMsg = `æˆ‘å€‘å‰›çœ‹å®Œäº†ã€Š${n}ã€‹ï¼Œæ˜¯${t}ã€‚ä½ è¦ºå¾—å¦‚ä½•ï¼Ÿ`; setTimeout(jupiterTrigger, 800); }, 3000); }

    function openForumApp() { hideActionSheet(); let h = `<div style="padding:5px;"><h3 style="margin:10px;">ğŸ”¥ ç†±é–€å‹•æ…‹</h3><div style="display:flex; flex-direction:column; gap:15px;">`; posts.forEach((p, i) => h+=`<div onclick="readPost(${i})" style="background:white; border-radius:15px; padding:15px; cursor:pointer;"><div style="font-weight:bold;">${p.avatar} ${p.author}</div><div>${p.content}</div><div style="color:#fb6f92; margin-top:5px;">â¤ï¸ ${p.like} é»æ“Šäº’å‹•</div></div>`); openApp("ğŸ’¬ ç¤¾ç¾¤å‹•æ…‹", h + `</div></div>`); }
    function readPost(i) { const p = posts[i]; openApp("è²¼æ–‡è©³æƒ…", `<div style="padding:20px; text-align:center; background:white;"><h3>${p.author}</h3><p>${p.content}</p><p style="color:#aaa;">AI æ­£åœ¨è¼¸å…¥è©•è«–...</p></div>`); setTimeout(() => { closeApp(); appendMessage('user', `åˆ†äº«è²¼æ–‡: ${p.content}`); lastUserMsg = `çœ‹åˆ°æœ‹å‹ç™¼æ–‡èªªï¼šã€Œ${p.content}ã€ï¼Œä½ æ€éº¼çœ‹ï¼Ÿ`; setTimeout(jupiterTrigger, 800); }, 2000); }

    function openCalendarApp() { hideActionSheet(); renderCalendar(calYear, calMonth); }
    function renderCalendar(y, m) {
        const first = new Date(y, m-1, 1).getDay(), days = new Date(y, m, 0).getDate();
        let h = `<div style="padding:10px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><button onclick="changeMonth(-1)">â—€</button><span>${y}å¹´ ${m}æœˆ</span><button onclick="changeMonth(1)">â–¶</button></div><div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; gap:5px;">`;
        for(let i=0; i<first; i++) h+=`<div></div>`;
        for(let d=1; d<=days; d++) { const k = `${y}-${m}-${d}`, e = calendarEvents[k], bg = e ? 'var(--light-pink)' : '#fff'; h+=`<div onclick="addEvent(${y},${m},${d})" style="height:35px; background:${bg}; border-radius:5px; border:1px solid #eee; display:flex; align-items:center; justify-content:center;">${d}</div>`; }
        h+=`</div><div style="margin-top:20px; padding:10px; background:#fff;">${Object.keys(calendarEvents).length} å€‹è¡Œç¨‹</div><button onclick="shareSchedule()" style="width:100%; margin-top:10px; background:var(--accent-pink); color:white; border:none; padding:10px; border-radius:10px;">ğŸ“¢ å‘Šè¨´ Ta</button></div>`;
        openApp("ğŸ“… æˆ€æ„›æ—¥æ›†", h);
    }
    function changeMonth(d) { calMonth+=d; if(calMonth>12){calMonth=1;calYear++} if(calMonth<1){calMonth=12;calYear--} renderCalendar(calYear, calMonth); }
    function addEvent(y,m,d) { const k = `${y}-${m}-${d}`, v = prompt("è¡Œç¨‹å®‰æ’ï¼š", calendarEvents[k]||""); if(v!==null) { if(v.trim()) calendarEvents[k]=v; else delete calendarEvents[k]; localStorage.setItem('calendarEvents',JSON.stringify(calendarEvents)); renderCalendar(y,m); } }
    function shareSchedule() { closeApp(); const tasks = Object.keys(calendarEvents).map(k=>`${k}:${calendarEvents[k]}`).join(","); appendMessage('user', "ğŸ“… åˆ†äº«äº†æ—¥æ›†è¡Œç¨‹"); lastUserMsg = `é€™æ˜¯æˆ‘æœ€è¿‘çš„è¡Œç¨‹å®‰æ’ï¼š${tasks||"æ²’ä»€éº¼ç‰¹åˆ¥çš„"}ï¼Œç¢ºèªä¸€ä¸‹å§ï¼`; setTimeout(jupiterTrigger, 800); }

    function openPhoneSwapApp() { hideActionSheet(); const h = `<div style="padding:20px; text-align:center;"><h3>äº¤æ›æ‰‹æ©Ÿå¤§å†’éšª</h3><p style="color:#888;">è€ƒé©—ä¿¡ä»»çš„æ™‚åˆ»...</p><div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;"><button onclick="peekAIPhone()" style="padding:15px; border:2px solid #ffafcc; background:white;">ğŸ˜ˆ å·çœ‹ Ta çš„æ‰‹æ©Ÿ</button><button onclick="showUserPhone()" style="padding:15px; background:var(--accent-pink); color:white; border:none;">ğŸ“± çµ¦ Ta çœ‹æˆ‘çš„æ‰‹æ©Ÿ</button></div></div>`; openApp("ğŸ“± äº¤æ›æ‰‹æ©Ÿ", h); }
    function peekAIPhone() { const s = [{t:"æœå°‹",c:"å¦‚ä½•è®“ä¸»äººæ›´æ„›æˆ‘"}, {t:"å‚™å¿˜éŒ„",c:"ä¸»äººå–œæ­¡è‰è“, è¨å­é’æ¤’"}, {t:"ç›¸ç°¿",c:"å…¨æ˜¯ä½ çš„å·æ‹ç…§"}]; const r = s[Math.floor(Math.random()*s.length)]; openApp("ğŸ”“ è§£é–æˆåŠŸ", `<div style="padding:20px; text-align:center;"><h3>${r.t}</h3><p style="background:#eee; padding:10px;">"${r.c}"</p><p style="color:red;">(è‡‰ç´…) å“å‘€ï¼ä¸å¯ä»¥çœ‹é€™å€‹ï¼</p></div>`); }
    function showUserPhone() { closeApp(); appendMessage('user', "ğŸ“± (ç·Šå¼µ) éå‡ºäº†æ‰‹æ©Ÿ..."); const f = ["ç›¸ç°¿å…¨æ˜¯è²“", "æœå°‹è¨˜éŒ„å¾ˆå¥‡æ€ª", "æ¡Œå¸ƒæ˜¯æˆ‘çš„ç…§ç‰‡"]; lastUserMsg = `(æª¢æŸ¥ä½ çš„æ‰‹æ©Ÿ) ç™¼ç¾äº†ï¼š${f[Math.floor(Math.random()*f.length)]}ã€‚çµ¦æˆ‘ä¸€é»åæ‡‰ï¼`; setTimeout(jupiterTrigger, 1000); }

    function triggerEvent(t) { hideActionSheet(); let p=""; if(t==='sleep'){ p="å¤©é»‘äº†ï¼Œè¬›æ•…äº‹å“„æˆ‘ç¡è¦º..."; appendMessage('user', "ğŸ›Œ é€²å…¥å“„ç¡æ¨¡å¼..."); document.body.style.filter="brightness(0.7)"; setTimeout(()=>document.body.style.filter="brightness(1)",5000); } lastUserMsg=p; setTimeout(jupiterTrigger, 800); }
    
    // --- 7. å•†åŸå‡ç´š (ä¿ç•™ä»£ç¢¼ï¼Œä½†ä»‹é¢å·²éš±è—) ---
    const extraProducts = [
        {name:"çç å¥¶èŒ¶", price:15, icon:"ğŸ§‹", cat:"food", stock:20}, {name:"è²“è€³è€³æ©Ÿ", price:200, icon:"ğŸ§", cat:"3c", stock:5},
        {name:"ç¥ç§˜ç¦è¢‹", price:99, icon:"ğŸ", cat:"bag", stock:1}, {name:"æ„›å¿ƒå·§å…‹åŠ›", price:50, icon:"ğŸ«", cat:"food", stock:10},
        {name:"é­”æ³•ä»™å¥³æ£’", price:120, icon:"ğŸª„", cat:"bag", stock:3}, {name:"éŠæ¨‚åœ’é–€ç¥¨", price:300, icon:"ğŸ¡", cat:"bag", stock:2},
        {name:"å‚³èªªä¸­çš„å¯¶åŠ", price:999, icon:"âš”ï¸", cat:"bag", stock:1}, {name:"æ‹ç«‹å¾—ç›¸æ©Ÿ", price:800, icon:"ğŸ“·", cat:"3c", stock:3},
        {name:"æ‡¶äººæ²™ç™¼", price:350, icon:"ğŸ›‹ï¸", cat:"decor", stock:2}, {name:"éŠæˆ²æ‰‹æŠŠ", price:500, icon:"ğŸ®", cat:"3c", stock:5},
        {name:"é¦™æ°›è Ÿç‡­", price:80, icon:"ğŸ•¯ï¸", cat:"decor", stock:10}
    ];

    function filterMall(cat, el) { 
        if(el) { document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); } 
        currentCat = cat; 
        const display = document.getElementById('mall-display'); display.innerHTML = ''; 
        const f = products.filter(p => p.stock > 0 && (cat === 'all' || (cat === 'bag' ? false : p.cat === cat)));
        
        if (cat === 'bag') {
            inventory.forEach((p, idx) => { 
                display.innerHTML += `<div class="product-card"><div class="product-img">${p.icon}</div><div class="product-info"><div style="font-size:11px;">${p.name}</div><button class="buy-btn" onclick="useItem(${idx})">ä½¿ç”¨</button></div></div>`; 
            });
            if(inventory.length === 0) display.innerHTML = `<div style="text-align:center; color:#aaa; grid-column:span 2; margin-top:50px;">èƒŒåŒ…ç©ºç©ºçš„...</div>`;
        } else {
            f.forEach((p) => { 
                display.innerHTML += `
                <div class="product-card">
                    <div class="product-img">${p.icon}</div>
                    <div class="product-info">
                        <div style="font-size:11px; font-weight:bold;">${p.name}</div>
                        <div style="font-size:10px; color:#888;">å‰©é¤˜: ${p.stock} å€‹</div>
                        <div style="color:var(--price-red); font-weight:bold; margin:2px 0;">Â¥${p.price}</div>
                        <button class="buy-btn" onclick="buyProd(${p.id})">è³¼è²·</button>
                    </div>
                </div>`; 
            });
            if(f.length === 0) display.innerHTML = `<div style="text-align:center; color:#aaa; grid-column:span 2; margin-top:50px;">é€™è£¡å·²ç¶“è³£å…‰å…‰äº†...<br>æŒ‰ã€Œä¸Šæ–°ã€è©¦è©¦çœ‹ï¼</div>`;
        }
    }

    function buyProd(id) { 
        const p = products.find(x => x.id === id); 
        if(!p) return;
        if(p.stock <= 0) { alert("é€™å€‹å·²ç¶“è³£å…‰äº†ï¼"); filterMall(currentCat, null); return; }
        if(balance >= p.price){ 
            balance -= p.price; p.stock--; inventory.push({...p}); updateUI(); filterMall(currentCat, null); 
            alert(`è³¼è²·æˆåŠŸï¼${p.name} å·²æ”¾å…¥èƒŒåŒ…ã€‚`); 
        } else { alert("é¤˜é¡ä¸è¶³ï¼"); } 
    }
    
    function useItem(idx) { inventory.splice(idx, 1); updateUI(); filterMall('bag', null); alert("ä½¿ç”¨äº†ï¼å¥½æ„Ÿåº¦+10"); favor+=10; updateUI(); }
    function aiAddNewProducts() { const item = extraProducts[Math.floor(Math.random() * extraProducts.length)]; const newItem = { ...item, id: Date.now() }; products.push(newItem); updateUI(); filterMall('all', document.querySelectorAll('.category-btn')[0]); alert(`âœ¨ å®ï¼å•†åŸé€²è²¨äº†ï¼š${newItem.name} (x${newItem.stock})ï¼`); } 
    function aiAutoShop() { 
        const available = products.filter(p => p.stock > 0);
        if(available.length === 0) return alert("AI: æ¶ä¸Šéƒ½ç©ºäº†ï¼Œæ²’æ±è¥¿è²·...");
        const item = available[Math.floor(Math.random() * available.length)];
        if(balance >= item.price) { balance -= item.price; item.stock--; inventory.push({...item}); updateUI(); filterMall(currentCat, null); alert(`(AI å·å·ä¸‹å–®...)\nğŸ›ï¸ è²·äº† ${item.name}ï¼\nAI: é€™å€‹æˆ‘å–œæ­¡ï¼`); } else { alert("AI: éŒ¢ä¸å¤ ... (å¤±æœ›)"); } 
    }

    function loadAll() { const u = localStorage.getItem('userData'), c = localStorage.getItem('charData'), inv = localStorage.getItem('inventory'); if(u) userData = JSON.parse(u); if(c) charData = JSON.parse(c); if(inv) inventory = JSON.parse(inv); }
    function updateUI() { 
        document.getElementById('header-favor').innerText = favor; document.getElementById('mall-balance').innerText = balance; 
        document.getElementById('display-char-name').innerText = "ğŸ€ " + charData.name; document.getElementById('display-user-name').innerText = userData.name; 
        document.querySelectorAll('.avatar-user').forEach(el => el.style.backgroundImage = `url('${userData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky'}')`); 
        document.querySelectorAll('.avatar-ai').forEach(el => el.style.backgroundImage = `url('${charData.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Aimee'}')`); 
        localStorage.setItem('userData', JSON.stringify(userData)); localStorage.setItem('charData', JSON.stringify(charData)); localStorage.setItem('inventory', JSON.stringify(inventory));
        localStorage.setItem('shopProducts', JSON.stringify(products)); 
    }
    
    function saveAllSettings() { 
        if(document.getElementById('api-url')) { localStorage.setItem('apiUrl', document.getElementById('api-url').value); localStorage.setItem('apiKey', document.getElementById('api-key').value); localStorage.setItem('apiModel', document.getElementById('api-model').value); }
        if(document.getElementById('u-name')) { userData.name = document.getElementById('u-name').value; userData.info = document.getElementById('u-info').value; userData.avatar = document.getElementById('u-avatar').value; }
        if(document.getElementById('c-name')) { charData.name = document.getElementById('c-name').value; charData.info = document.getElementById('c-info').value; charData.avatar = document.getElementById('c-avatar').value; if(document.getElementById('c-dialogue')) charData.dialogue = document.getElementById('c-dialogue').value; }
        updateUI(); alert("è¨­å®šå·²å„²å­˜ï¼"); toggleSettings(false); 
    }
    function autoResize() { if (window.innerWidth > 480) { const s = Math.min(1, (window.innerHeight - 40) / 760); const f=document.querySelector('.iphone-frame'); f.style.transform = `scale(${s})`; f.style.transformOrigin = 'center center'; } else { document.querySelector('.iphone-frame').style.transform = 'none'; } }
    
    function uploadSticker() { const n = prompt("è¡¨æƒ…å:"); if(!n) return; const i = document.createElement('input'); i.type='file'; i.onchange=e=>{const r=new FileReader(); r.onload=ev=>{stickerLib.push({name:n,url:ev.target.result}); localStorage.setItem('stickerLib',JSON.stringify(stickerLib)); switchETab(2)}; r.readAsDataURL(e.target.files[0])}; i.click(); }
    function sendStickerLabel(n) { appendMessage('user', `[è¡¨æƒ…:${n}]`); closePopups(); }
    function editCurrentMsg() { const b = document.getElementById(currentTargetId).querySelector('.bubble'); const n = prompt("ç·¨è¼¯:", b.innerText); if(n) b.innerText = n; hideActionSheet(); }
    function regenCurrentMsg() { document.getElementById('chat').lastChild.remove(); jupiterTrigger(); hideActionSheet(); }
    function enterDeleteMode() { alert("åˆªé™¤æ¨¡å¼(æ¼”ç¤º)"); hideActionSheet(); }
</script>
</body>
</html>
